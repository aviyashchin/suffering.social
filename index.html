<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO and Meta Tags -->
    <title>Social Media Cost Calculator | Economic Impact Analysis</title>
    <meta name="description" content="Research-based calculator estimating the economic and human costs of social media's impact on mental health. Based on peer-reviewed studies.">
    
    <!-- External Dependencies with Fallbacks -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- noUiSlider - Professional Range Sliders -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
    
    <!-- Chart.js for Visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    
    <!-- D3.js for Distribution Curves -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Modular CSS -->
    <link rel="stylesheet" href="src/styles/base.css">
    <link rel="stylesheet" href="src/styles/components.css">
    <link rel="stylesheet" href="src/styles/calculator.css">
    <link rel="stylesheet" href="src/styles/mobile.css">
    
    <!-- Error Handling & Loading States -->
    <style>
        /* Loading State */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-family: system-ui, sans-serif;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error State */
        .error-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fee2e2;
            border-bottom: 1px solid #fecaca;
            padding: 1rem;
            text-align: center;
            z-index: 9998;
            display: none;
        }
        
        .error-banner.show {
            display: block;
        }
        
        /* Fallback Slider Styling */
        .fallback-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .fallback-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .fallback-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading">
        <div class="text-center">
            <div class="spinner mb-4"></div>
            <div class="text-gray-600">Loading Calculator...</div>
        </div>
    </div>
    
    <!-- Error Banner -->
    <div id="error-banner" class="error-banner">
        <div class="text-red-700">
            <strong>Loading Error:</strong> Some features may not work properly. 
            <button onclick="location.reload()" class="ml-2 px-3 py-1 bg-red-100 rounded hover:bg-red-200">
                Refresh Page
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-gray-900">
                Social Media Cost Calculator
            </h1>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-calculator" class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Hero Section -->
        <section class="text-center mb-12">
            <h2 class="text-4xl font-bold text-gray-900 mb-4">
                The Hidden Economic Cost of Social Media
            </h2>
            
            <!-- Total Cost Display -->
            <div class="bg-gradient-to-r from-red-500 to-purple-600 text-white rounded-2xl p-8 mb-8">
                <div class="text-6xl font-bold mb-2" id="hero-total-cost">$3.2T</div>
                <div class="text-2xl opacity-90">Annual Economic Impact</div>
                <div class="text-lg opacity-75 mt-2">
                    That's <span id="gdp-percentage">13.3%</span> of US GDP
                </div>
            </div>
        </section>

        <!-- Calculator Interface -->
        <section class="grid lg:grid-cols-2 gap-8 mb-12">
            
            <!-- Parameter Controls -->
            <div class="space-y-6">
                <h3 class="text-2xl font-semibold text-gray-900 mb-6">
                    Research Parameters
                </h3>
                
                <!-- Mortality Parameters -->
                <div class="bg-white rounded-lg p-6 shadow-sm parameter-group" data-group="mortality">
                    <h4 class="text-lg font-semibold text-red-700 mb-4">
                        ‚ò†Ô∏è Mortality Costs
                    </h4>
                    
                    <!-- VSL Slider -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Value of Statistical Life
                        </label>
                        <div id="vsl-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="vsl-value">$13.7M</div>
                        <div class="distribution-chart-container" data-parameter="vsl">
                            <svg id="vsl-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="vsl-stats">Mean: $13.7M | 95% CI: [$10.2M, $17.8M]</div>
                        </div>
                    </div>
                    
                    <!-- Excess Deaths Slider -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Excess Deaths Since 2009
                        </label>
                        <div id="suicides-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="suicides-value">110K</div>
                        <div class="distribution-chart-container" data-parameter="suicides">
                            <svg id="suicides-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="suicides-stats">Mean: 110K | 95% CI: [89K, 140K]</div>
                        </div>
                    </div>
                    
                    <!-- Attribution Slider -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Attribution to Social Media
                        </label>
                        <div id="attribution-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="attribution-value">18%</div>
                        <div class="distribution-chart-container" data-parameter="attribution">
                            <svg id="attribution-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="attribution-stats">Mean: 18% | 95% CI: [12%, 25%]</div>
                        </div>
                    </div>
                </div>
                
                <!-- Mental Health Parameters -->
                <div class="bg-white rounded-lg p-6 shadow-sm parameter-group" data-group="mental-health">
                    <h4 class="text-lg font-semibold text-purple-700 mb-4">
                        üß† Mental Health Costs
                    </h4>
                    
                    <!-- Affected Population -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            People with SM-Induced Depression
                        </label>
                        <div id="depression-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="depression-value">5.0M</div>
                        <div class="distribution-chart-container" data-parameter="depression">
                            <svg id="depression-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="depression-stats">Mean: 5.0M | 95% CI: [3.5M, 8.0M]</div>
                        </div>
                    </div>
                    
                    <!-- Years Lived with Disability -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Years Lived with Disability
                        </label>
                        <div id="yld-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="yld-value">6.0 years</div>
                        <div class="distribution-chart-container" data-parameter="yld">
                            <svg id="yld-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="yld-stats">Mean: 6.0yr | 95% CI: [4.8yr, 7.5yr]</div>
                        </div>
                    </div>
                    
                    <!-- Quality of Life Impact -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Quality of Life Reduction
                        </label>
                        <div id="qol-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="qol-value">35%</div>
                        <div class="distribution-chart-container" data-parameter="qol">
                            <svg id="qol-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="qol-stats">Mean: 35% | 95% CI: [31%, 47%]</div>
                        </div>
                    </div>
                </div>
                
                <!-- Economic Parameters -->
                <div class="bg-white rounded-lg p-6 shadow-sm parameter-group" data-group="healthcare">
                    <h4 class="text-lg font-semibold text-green-700 mb-4">
                        üí∞ Economic Costs
                    </h4>
                    
                    <!-- Healthcare Costs -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Annual Healthcare Cost per Person
                        </label>
                        <div id="healthcare-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="healthcare-value">$7K</div>
                        <div class="distribution-chart-container" data-parameter="healthcare">
                            <svg id="healthcare-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="healthcare-stats">Mean: $7K | 95% CI: [$6.5K, $12K]</div>
                        </div>
                    </div>
                    
                    <!-- Productivity Loss -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Annual Productivity Loss per Person
                        </label>
                        <div id="productivity-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="productivity-value">$6K</div>
                        <div class="distribution-chart-container" data-parameter="productivity">
                            <svg id="productivity-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="productivity-stats">Mean: $6K | 95% CI: [$4.8K, $8.5K]</div>
                        </div>
                    </div>
                    
                    <!-- Treatment Duration -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Average Treatment Duration
                        </label>
                        <div id="duration-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="duration-value">4.5 years</div>
                        <div class="distribution-chart-container" data-parameter="duration">
                            <svg id="duration-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="duration-stats">Mean: 4.5yr | 95% CI: [3.0yr, 6.8yr]</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Display -->
            <div class="space-y-6">
                <h3 class="text-2xl font-semibold text-gray-900 mb-6">
                    Economic Impact Results
                </h3>
                
                <!-- Formula Results -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="text-lg font-semibold mb-4">Cost Breakdown</h4>
                    
                    <div class="mb-4 p-4 bg-red-50 rounded-lg">
                        <div class="font-medium text-red-700">Mortality Costs</div>
                        <div class="text-sm text-gray-600" id="mortality-result">
                            110K √ó 18% √ó $13.7M = $271B
                        </div>
                    </div>
                    
                    <div class="mb-4 p-4 bg-purple-50 rounded-lg">
                        <div class="font-medium text-purple-700">Mental Health Costs</div>
                        <div class="text-sm text-gray-600" id="mental-result">
                            5.0M √ó 6.0 √ó 35% √ó $183K = $1.9T
                        </div>
                    </div>
                    
                    <div class="mb-4 p-4 bg-green-50 rounded-lg">
                        <div class="font-medium text-green-700">Economic Costs</div>
                        <div class="text-sm text-gray-600" id="healthcare-result">
                            5.0M √ó ($7K + $6K) √ó 4.5 = $293B
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="text-2xl font-bold">
                            Total: <span id="total-cost">$3.2T</span>
                        </div>
                    </div>
                </div>
                
                <!-- Scenario Buttons -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="text-lg font-semibold mb-4">Research Scenarios</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="scenario-btn px-4 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors" data-scenario="reset">
                            üî¨ Research Consensus
                        </button>
                        <button class="scenario-btn px-4 py-2 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" data-scenario="optimistic">
                            üåü Most Optimistic
                        </button>
                        <button class="scenario-btn px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors" data-scenario="aggressive">
                            üö® Worst Case
                        </button>
                        <button class="scenario-btn px-4 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors" data-scenario="facebookFiles">
                            üì± Facebook Files
                        </button>
                    </div>
                </div>
                
                <!-- Research Charts -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="text-lg font-semibold mb-4">Impact Visualization</h4>
                    <canvas id="breakdown-chart" width="400" height="200"></canvas>
                </div>
            </div>
        </section>

        <!-- Share Section -->
        <section class="text-center">
            <h3 class="text-2xl font-semibold text-gray-900 mb-6">
                Share These Findings
            </h3>
            <div class="flex justify-center space-x-4">
                <button id="share-twitter" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    Share on Twitter
                </button>
                <button id="share-linkedin" class="px-6 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors">
                    Share on LinkedIn
                </button>
                <button id="share-facebook" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Share on Facebook
                </button>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12 mt-16">
        <div class="max-w-7xl mx-auto px-4">
            <div class="text-center">
                <p class="text-gray-300">
                    Built using peer-reviewed research and federal agency methodologies
                </p>
                <p class="text-gray-400 text-sm mt-2">
                    &copy; 2024 Social Media Cost Calculator. Open source research project.
                </p>
            </div>
        </div>
    </footer>

    <!-- Error Handling & Initialization -->
    <script>
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            document.getElementById('error-banner').classList.add('show');
        });
        
        // Library loading verification
        let librariesLoaded = {
            tailwind: false,
            nouislider: false,
            chartjs: false,
            d3: false
        };
        
        // Check library loading
        function checkLibraries() {
            librariesLoaded.tailwind = typeof window.tailwind !== 'undefined' || document.querySelector('.bg-gray-50') !== null;
            librariesLoaded.nouislider = typeof noUiSlider !== 'undefined';
            librariesLoaded.chartjs = typeof Chart !== 'undefined';
            librariesLoaded.d3 = typeof d3 !== 'undefined';
            
            console.log('üìö Libraries loaded:', librariesLoaded);
            
            // Show warnings for missing libraries
            const missing = Object.entries(librariesLoaded).filter(([key, loaded]) => !loaded);
            if (missing.length > 0) {
                console.warn('‚ö†Ô∏è Missing libraries:', missing.map(([key]) => key));
            }
        }
        
        // Initialize with timeout
        let initTimeout;
        function attemptInitialization() {
            clearTimeout(initTimeout);
            checkLibraries();
            
            // Wait a bit more if libraries are still loading
            if (!librariesLoaded.nouislider || !librariesLoaded.d3) {
                console.log('‚è≥ Waiting for libraries to load...');
                initTimeout = setTimeout(attemptInitialization, 500);
                return;
            }
            
            // Hide loading screen
            document.getElementById('loading-screen').classList.add('hidden');
            
            // Initialize the calculator app
            if (typeof window.socialMediaApp !== 'undefined') {
                console.log('‚úÖ Calculator already initialized');
            }
        }
        
        // Start checking after a short delay
        setTimeout(attemptInitialization, 100);
    </script>

    <!-- Modular JavaScript -->
    <script type="module" src="src/main.js"></script>

    <!-- Working Calculator Implementation -->
    <script>
        // Working Calculator Class from v5
        class SocialMediaCalculator {
            constructor() {
                this.parameters = {
                    vsl: 13.7,
                    suicides: 110000,
                    attribution: 18,
                    depression: 5000000,
                    yld: 6.0,
                    qol: 35,
                    healthcare: 7000,
                    productivity: 6000,
                    duration: 4.5
                };
                
                this.scenarios = {
                    reset: { vsl: 13.7, suicides: 110000, attribution: 18, depression: 5000000, yld: 6.0, qol: 35, healthcare: 7000, productivity: 6000, duration: 4.5 },
                    aggressive: { vsl: 20.0, suicides: 300000, attribution: 30, depression: 15000000, yld: 8.0, qol: 40, healthcare: 20000, productivity: 10000, duration: 6.0 },
                    facebookFiles: { vsl: 15.0, suicides: 180000, attribution: 22, depression: 8000000, yld: 6.5, qol: 38, healthcare: 10000, productivity: 7500, duration: 5.2 },
                    optimistic: { vsl: 8.0, suicides: 100000, attribution: 5, depression: 3000000, yld: 4.0, qol: 30, healthcare: 6500, productivity: 6000, duration: 3.0 }
                };
                
                this.init();
            }
            
            init() {
                console.log('üöÄ Initializing calculator...');
                this.setupSliders();
                this.setupScenarioButtons();
                this.setupDistributionCharts();
                this.setupShareButtons();
                this.updateAllDisplays();
                console.log('‚úÖ Calculator initialized successfully');
            }
            
            setupSliders() {
                if (typeof noUiSlider === 'undefined') {
                    console.warn('noUiSlider not available, waiting...');
                    setTimeout(() => this.setupSliders(), 100);
                    return;
                }
                
                const sliderConfigs = {
                    'vsl': { range: { min: 7.2, max: 14.0 }, start: 13.7, step: 0.1 },
                    'suicides': { range: { min: 89000, max: 300000 }, start: 110000, step: 1000 },
                    'attribution': { range: { min: 5, max: 30 }, start: 18, step: 1 },
                    'depression': { range: { min: 3000000, max: 15000000 }, start: 5000000, step: 100000 },
                    'yld': { range: { min: 4.8, max: 8.2 }, start: 6.0, step: 0.1 },
                    'qol': { range: { min: 31, max: 47 }, start: 35, step: 1 },
                    'healthcare': { range: { min: 6500, max: 20000 }, start: 7000, step: 100 },
                    'productivity': { range: { min: 4800, max: 10000 }, start: 6000, step: 100 },
                    'duration': { range: { min: 3.0, max: 8.5 }, start: 4.5, step: 0.1 }
                };
                
                Object.keys(sliderConfigs).forEach(param => {
                    this.createSlider(param, sliderConfigs[param]);
                });
                
                console.log('‚úÖ Sliders initialized');
            }
            
            createSlider(param, config) {
                const container = document.getElementById(`${param}-nouislider`);
                if (!container) {
                    console.warn(`Container for ${param} not found`);
                    return;
                }
                
                try {
                    noUiSlider.create(container, {
                        range: config.range,
                        start: config.start,
                        step: config.step,
                        connect: 'lower',
                        tooltips: {
                            to: (value) => this.formatParameter(param, value),
                            from: (value) => Number(value)
                        }
                    });
                    
                    container.noUiSlider.on('update', (values, handle) => {
                        const value = parseFloat(values[handle]);
                        this.parameters[param] = value;
                        this.updateDisplay(param, value);
                        this.updateDistributionChart(param);
                    });
                    
                    container.noUiSlider.on('change', () => {
                        this.updateAllDisplays();
                    });
                    
                    console.log(`‚úÖ Created slider for ${param}`);
                    
                } catch (error) {
                    console.error(`Failed to create slider for ${param}:`, error);
                }
            }
            
            setupScenarioButtons() {
                const scenarioButtons = document.querySelectorAll('.scenario-btn');
                scenarioButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const scenario = e.target.dataset.scenario;
                        this.loadScenario(scenario);
                        console.log(`‚úÖ Loaded scenario: ${scenario}`);
                    });
                });
                console.log('‚úÖ Scenario buttons initialized');
            }
            
            loadScenario(scenarioName) {
                const scenario = this.scenarios[scenarioName];
                if (!scenario) return;
                
                Object.keys(scenario).forEach(param => {
                    this.parameters[param] = scenario[param];
                    
                    // Update slider
                    const container = document.getElementById(`${param}-nouislider`);
                    if (container && container.noUiSlider) {
                        container.noUiSlider.set(scenario[param]);
                    }
                    
                    this.updateDisplay(param, scenario[param]);
                    this.updateDistributionChart(param);
                });
                
                this.updateAllDisplays();
            }
            
            setupDistributionCharts() {
                if (typeof d3 === 'undefined') {
                    console.warn('D3.js not available, skipping distribution charts');
                    return;
                }
                
                const parameters = ['vsl', 'suicides', 'attribution', 'depression', 'yld', 'qol', 'healthcare', 'productivity', 'duration'];
                parameters.forEach(param => {
                    this.createDistributionChart(param);
                    this.updateDistributionStats(param);
                });
                
                console.log('‚úÖ Distribution charts initialized');
            }
            
            createDistributionChart(param) {
                const container = document.getElementById(`${param}-distribution`);
                if (!container) return;
                
                const width = 250;
                const height = 60;
                const margin = { top: 5, right: 10, bottom: 5, left: 10 };
                
                // Clear existing
                d3.select(container).selectAll('*').remove();
                
                const svg = d3.select(container)
                    .attr('width', width)
                    .attr('height', height);
                
                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);
                
                // Generate curve data
                const data = this.generateCurveData(param);
                
                const xScale = d3.scaleLinear()
                    .domain(d3.extent(data, d => d.x))
                    .range([0, width - margin.left - margin.right]);
                
                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.y)])
                    .range([height - margin.top - margin.bottom, 0]);
                
                const line = d3.line()
                    .x(d => xScale(d.x))
                    .y(d => yScale(d.y))
                    .curve(d3.curveCardinal);
                
                const area = d3.area()
                    .x(d => xScale(d.x))
                    .y0(yScale(0))
                    .y1(d => yScale(d.y))
                    .curve(d3.curveCardinal);
                
                // Get colors
                const colors = this.getParameterColors(param);
                
                // Draw area
                g.append('path')
                    .datum(data)
                    .attr('class', 'distribution-fill')
                    .attr('d', area)
                    .style('fill', colors.fill)
                    .style('opacity', 0.6);
                
                // Draw line
                g.append('path')
                    .datum(data)
                    .attr('class', 'distribution-path')
                    .attr('d', line)
                    .style('fill', 'none')
                    .style('stroke', colors.stroke)
                    .style('stroke-width', 2);
                
                // Add current value indicator
                this.addCurrentValueIndicator(g, param, xScale, yScale);
            }
            
            generateCurveData(param) {
                const config = this.getParameterConfig(param);
                const data = [];
                const numPoints = 50;
                
                for (let i = 0; i <= numPoints; i++) {
                    const x = config.min + (config.max - config.min) * (i / numPoints);
                    let y;
                    
                    if (config.type === 'normal') {
                        const variance = config.std * config.std;
                        const exponent = -0.5 * Math.pow((x - config.mean) / config.std, 2);
                        y = Math.exp(exponent) / (config.std * Math.sqrt(2 * Math.PI));
                    } else {
                        // Skewed distribution
                        const logX = Math.log(Math.max(x, 1));
                        const logMean = Math.log(config.mean);
                        const logStd = 0.5;
                        const exponent = -0.5 * Math.pow((logX - logMean) / logStd, 2);
                        y = Math.exp(exponent) / (x * logStd * Math.sqrt(2 * Math.PI));
                    }
                    
                    data.push({ x, y });
                }
                
                return data;
            }
            
            getParameterConfig(param) {
                const configs = {
                    vsl: { type: 'normal', min: 7.2, max: 14.0, mean: 13.7, std: 1.5 },
                    suicides: { type: 'skewed', min: 89000, max: 300000, mean: 110000, std: 35000 },
                    attribution: { type: 'normal', min: 5, max: 30, mean: 18, std: 4 },
                    depression: { type: 'skewed', min: 3000000, max: 15000000, mean: 5000000, std: 2000000 },
                    yld: { type: 'normal', min: 4.8, max: 8.2, mean: 6.0, std: 0.8 },
                    qol: { type: 'normal', min: 31, max: 47, mean: 35, std: 4 },
                    healthcare: { type: 'skewed', min: 6500, max: 20000, mean: 7000, std: 2500 },
                    productivity: { type: 'skewed', min: 4800, max: 10000, mean: 6000, std: 1500 },
                    duration: { type: 'normal', min: 3.0, max: 8.5, mean: 4.5, std: 1.2 }
                };
                return configs[param];
            }
            
            getParameterColors(param) {
                const mortalityParams = ['vsl', 'suicides', 'attribution'];
                const mentalHealthParams = ['depression', 'yld', 'qol'];
                const economicParams = ['healthcare', 'productivity', 'duration'];
                
                if (mortalityParams.includes(param)) {
                    return { stroke: '#dc2626', fill: 'rgba(220, 38, 38, 0.1)' };
                } else if (mentalHealthParams.includes(param)) {
                    return { stroke: '#8b5cf6', fill: 'rgba(139, 92, 246, 0.1)' };
                } else {
                    return { stroke: '#10b981', fill: 'rgba(16, 185, 129, 0.1)' };
                }
            }
            
            addCurrentValueIndicator(g, param, xScale, yScale) {
                const currentValue = this.parameters[param];
                const x = xScale(currentValue);
                
                g.append('line')
                    .attr('class', 'current-value-line')
                    .attr('x1', x)
                    .attr('x2', x)
                    .attr('y1', 0)
                    .attr('y2', yScale.range()[0])
                    .style('stroke', '#ef4444')
                    .style('stroke-width', 2)
                    .style('stroke-dasharray', '3,3');
                
                g.append('circle')
                    .attr('class', 'current-value-dot')
                    .attr('cx', x)
                    .attr('cy', 5)
                    .attr('r', 3)
                    .style('fill', '#ef4444')
                    .style('stroke', '#ffffff')
                    .style('stroke-width', 1);
            }
            
            updateDistributionChart(param) {
                // Recreate the chart with new current value
                this.createDistributionChart(param);
                
                // Update distribution statistics
                this.updateDistributionStats(param);
            }
            
            updateDistributionStats(param) {
                const statsElement = document.getElementById(`${param}-stats`);
                if (!statsElement) return;
                
                const config = this.getParameterConfig(param);
                const currentValue = this.parameters[param];
                
                // Calculate 95% confidence interval
                const ciLow = config.type === 'normal' ? 
                    config.mean - (1.96 * config.std) : 
                    config.mean * 0.7;
                const ciHigh = config.type === 'normal' ? 
                    config.mean + (1.96 * config.std) : 
                    config.mean * 1.4;
                
                // Format the statistics text
                const meanText = this.formatParameter(param, currentValue);
                const ciLowText = this.formatParameter(param, Math.max(config.min, ciLow));
                const ciHighText = this.formatParameter(param, Math.min(config.max, ciHigh));
                
                statsElement.textContent = `Current: ${meanText} | 95% CI: [${ciLowText}, ${ciHighText}]`;
            }
            
            formatParameter(param, value) {
                const formatters = {
                    vsl: v => `$${v.toFixed(1)}M`,
                    suicides: v => `${Math.round(v/1000)}K`,
                    attribution: v => `${Math.round(v)}%`,
                    depression: v => `${(v/1000000).toFixed(1)}M`,
                    yld: v => `${v.toFixed(1)} years`,
                    qol: v => `${Math.round(v)}%`,
                    healthcare: v => `$${Math.round(v/1000)}K`,
                    productivity: v => `$${Math.round(v/1000)}K`,
                    duration: v => `${v.toFixed(1)} years`
                };
                return formatters[param] ? formatters[param](value) : value.toString();
            }
            
            updateDisplay(param, value) {
                const display = document.getElementById(`${param}-value`);
                if (display) {
                    display.textContent = this.formatParameter(param, value);
                }
            }
            
            calculateTotalEconomicImpact() {
                const { vsl, suicides, attribution, depression, yld, qol, healthcare, productivity, duration } = this.parameters;
                
                // Mortality costs
                const mortalityCosts = suicides * (attribution / 100) * vsl * 1000000;
                
                // Mental health costs
                const annualLifeValue = (vsl * 1000000) / 75;
                const mentalCosts = depression * yld * (qol / 100) * annualLifeValue;
                
                // Economic costs
                const economicCosts = depression * (healthcare + productivity) * duration;
                
                const total = mortalityCosts + mentalCosts + economicCosts;
                
                return {
                    mortality: mortalityCosts,
                    mental: mentalCosts,
                    productivity: economicCosts,
                    total
                };
            }
            
            formatLargeNumber(value) {
                if (value >= 1e12) {
                    return `$${(value / 1e12).toFixed(1)}T`;
                } else if (value >= 1e9) {
                    return `$${(value / 1e9).toFixed(1)}B`;
                } else if (value >= 1e6) {
                    return `$${(value / 1e6).toFixed(1)}M`;
                } else {
                    return `$${Math.round(value).toLocaleString()}`;
                }
            }
            
            updateAllDisplays() {
                const results = this.calculateTotalEconomicImpact();
                
                // Update main displays
                const totalElement = document.getElementById('total-cost');
                if (totalElement) totalElement.textContent = this.formatLargeNumber(results.total);
                
                const heroTotalElement = document.getElementById('hero-total-cost');
                if (heroTotalElement) heroTotalElement.textContent = this.formatLargeNumber(results.total);
                
                // Update GDP percentage
                const gdpElement = document.getElementById('gdp-percentage');
                if (gdpElement) {
                    const gdpPercentage = (results.total / 24e12) * 100;
                    gdpElement.textContent = `${gdpPercentage.toFixed(1)}%`;
                }
                
                // Update formula displays
                this.updateFormulaDisplays(results);
                
                // Update chart
                this.updateBreakdownChart(results);
                
                console.log('‚úÖ All displays updated:', results);
            }
            
            updateBreakdownChart(results) {
                const canvas = document.getElementById('breakdown-chart');
                if (!canvas || typeof Chart === 'undefined') return;
                
                // Destroy existing chart
                if (this.chart) {
                    this.chart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mortality Costs', 'Mental Health Costs', 'Economic Costs'],
                        datasets: [{
                            data: [results.mortality, results.mental, results.productivity],
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.8)',   // Red for mortality
                                'rgba(147, 51, 234, 0.8)',  // Purple for mental health
                                'rgba(34, 197, 94, 0.8)'    // Green for economic
                            ],
                            borderColor: [
                                'rgb(239, 68, 68)',
                                'rgb(147, 51, 234)',
                                'rgb(34, 197, 94)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = this.formatLargeNumber(context.raw);
                                        const percentage = ((context.raw / results.total) * 100).toFixed(1);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            setupShareButtons() {
                const shareButtons = {
                    'share-twitter': this.shareOnTwitter.bind(this),
                    'share-linkedin': this.shareOnLinkedIn.bind(this),
                    'share-facebook': this.shareOnFacebook.bind(this)
                };
                
                Object.keys(shareButtons).forEach(buttonId => {
                    const button = document.getElementById(buttonId);
                    if (button) {
                        button.addEventListener('click', shareButtons[buttonId]);
                    }
                });
            }
            
            shareOnTwitter() {
                const results = this.calculateTotalEconomicImpact();
                const text = `Social media's hidden cost: ${this.formatLargeNumber(results.total)} annually in economic damage. That's ${((results.total / 24e12) * 100).toFixed(1)}% of US GDP! üìä`;
                const url = encodeURIComponent(window.location.href);
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${url}`, '_blank');
            }
            
            shareOnLinkedIn() {
                const url = encodeURIComponent(window.location.href);
                const title = 'Social Media Economic Impact Calculator';
                const summary = 'Research-based analysis of social media\'s economic costs';
                window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}&title=${encodeURIComponent(title)}&summary=${encodeURIComponent(summary)}`, '_blank');
            }
            
            shareOnFacebook() {
                const url = encodeURIComponent(window.location.href);
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
            }
            
            updateFormulaDisplays(results) {
                const { suicides, attribution, vsl, depression, yld, qol, healthcare, productivity, duration } = this.parameters;
                
                // Mortality formula
                const mortalityElement = document.getElementById('mortality-result');
                if (mortalityElement) {
                    mortalityElement.textContent = `${Math.round(suicides/1000)}K √ó ${attribution}% √ó $${vsl}M = ${this.formatLargeNumber(results.mortality)}`;
                }
                
                // Mental health formula
                const mentalElement = document.getElementById('mental-result');
                if (mentalElement) {
                    mentalElement.textContent = `${(depression/1000000).toFixed(1)}M √ó ${yld} √ó ${qol}% √ó $${Math.round(vsl * 1000000 / 75 / 1000)}K = ${this.formatLargeNumber(results.mental)}`;
                }
                
                // Economic formula
                const economicElement = document.getElementById('healthcare-result');
                if (economicElement) {
                    economicElement.textContent = `${(depression/1000000).toFixed(1)}M √ó ($${Math.round(healthcare/1000)}K + $${Math.round(productivity/1000)}K) √ó ${duration} = ${this.formatLargeNumber(results.productivity)}`;
                }
            }
        }
        
        // Initialize calculator when libraries are loaded
        function initializeCalculator() {
            if (typeof noUiSlider !== 'undefined' && typeof d3 !== 'undefined') {
                try {
                    window.calculator = new SocialMediaCalculator();
                    console.log('‚úÖ Calculator initialized successfully');
                    
                    // Initialize all parameter displays
                    Object.keys(window.calculator.parameters).forEach(param => {
                        window.calculator.updateDisplay(param, window.calculator.parameters[param]);
                    });
                    
                    // Add debug utilities
                    window.testSliders = function() {
                        console.log('üß™ Testing sliders...');
                        const params = ['vsl', 'attribution', 'depression'];
                        params.forEach(param => {
                            const container = document.getElementById(`${param}-nouislider`);
                            if (container && container.noUiSlider) {
                                console.log(`‚úÖ ${param} slider: Working`);
                            } else {
                                console.log(`‚ùå ${param} slider: Not found`);
                            }
                        });
                    };
                    
                    window.testCharts = function() {
                        console.log('üß™ Testing distribution charts...');
                        const params = ['vsl', 'attribution', 'depression'];
                        params.forEach(param => {
                            const chart = document.getElementById(`${param}-distribution`);
                            const hasElements = chart && chart.children.length > 0;
                            console.log(`${hasElements ? '‚úÖ' : '‚ùå'} ${param} chart: ${hasElements ? 'Rendered' : 'Empty'}`);
                        });
                    };
                    
                    window.testScenarios = function() {
                        console.log('üß™ Testing scenarios...');
                        window.calculator.loadScenario('optimistic');
                        setTimeout(() => {
                            window.calculator.loadScenario('aggressive');
                            setTimeout(() => {
                                window.calculator.loadScenario('reset');
                                console.log('‚úÖ All scenarios tested');
                            }, 500);
                        }, 500);
                    };
                    
                    console.log('üîß Debug utilities available:');
                    console.log('  testSliders() - Test slider functionality');
                    console.log('  testCharts() - Test distribution charts');
                    console.log('  testScenarios() - Test scenario loading');
                    
                    // Hide loading screen
                    document.getElementById('loading-screen').classList.add('hidden');
                } catch (error) {
                    console.error('‚ùå Calculator initialization failed:', error);
                    document.getElementById('error-banner').classList.add('show');
                }
            } else {
                console.log('‚è≥ Waiting for libraries...');
                setTimeout(initializeCalculator, 100);
            }
        }
        
        // Start initialization
        window.addEventListener('load', () => {
            setTimeout(initializeCalculator, 100);
        });
    </script>

    <!-- Enhanced Analytics for Modular System -->
    <script>
      // Track modular system performance
      if (typeof gtag !== 'undefined') {
        gtag('config', 'G-RQ28MDK57K', {
          custom_map: {
            'system_type': 'modular',
            'version': '2.1'
          }
        });
        
        // Track system initialization
        window.addEventListener('load', () => {
          gtag('event', 'modular_system_loaded', {
            'event_category': 'performance',
            'file_size_reduction': '95%',
            'architecture': 'modular_enhanced'
          });
        });
      }
    </script>
    
    <!-- Google tag (gtag.js) -->
</body>
</html> 