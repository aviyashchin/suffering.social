<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO and Meta Tags -->
    <title>Social Media Cost Calculator | Economic Impact Analysis</title>
    <meta name="description" content="Research-based calculator estimating the economic and human costs of social media's impact on mental health. Based on peer-reviewed studies.">
    
    <!-- External Dependencies with Fallbacks -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- noUiSlider - Professional Range Sliders -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
    
    <!-- Chart.js for Visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    
    <!-- D3.js for Distribution Curves -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Modular CSS -->
    <link rel="stylesheet" href="src/styles/base.css">
    <link rel="stylesheet" href="src/styles/components.css">
    <link rel="stylesheet" href="src/styles/calculator.css">
    <link rel="stylesheet" href="src/styles/mobile.css">
    
    <!-- Error Handling & Loading States -->
    <style>
        /* Loading State */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-family: system-ui, sans-serif;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error State */
        .error-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fee2e2;
            border-bottom: 1px solid #fecaca;
            padding: 1rem;
            text-align: center;
            z-index: 9998;
            display: none;
        }
        
        .error-banner.show {
            display: block;
        }
        
        /* Mobile Enhancements */
        @media (max-width: 768px) {
            .info-btn {
                padding: 8px 12px;
                font-size: 16px;
                min-height: 44px;
                min-width: 44px;
            }
            
            .scenario-btn {
                padding: 12px 16px;
                font-size: 14px;
                min-height: 44px;
            }
            
            .distribution-chart-container {
                margin-bottom: 16px;
                padding: 8px;
                border-radius: 8px;
                background: rgba(0, 0, 0, 0.02);
            }
            
            .distribution-chart {
                touch-action: none;
                user-select: none;
            }
            
            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
            }
            
            .parameter-group {
                margin-bottom: 24px;
            }
        }
        
        /* Touch-friendly elements */
        .info-btn, .scenario-btn, button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Smooth scrolling for mobile */
        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Fallback Slider Styling */
        .fallback-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .fallback-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .fallback-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading">
        <div class="text-center">
            <div class="spinner mb-4"></div>
            <div class="text-gray-600">Loading Calculator...</div>
        </div>
    </div>
    
    <!-- Error Banner -->
    <div id="error-banner" class="error-banner">
        <div class="text-red-700">
            <strong>Loading Error:</strong> Some features may not work properly. 
            <button onclick="location.reload()" class="ml-2 px-3 py-1 bg-red-100 rounded hover:bg-red-200">
                Refresh Page
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-gray-900">
                Social Media Cost Calculator
            </h1>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-calculator" class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Hero Section -->
        <section class="text-center mb-12">
            <h2 class="text-4xl font-bold text-gray-900 mb-4">
                The Hidden Economic Cost of Social Media
            </h2>
            
            <!-- Total Cost Display -->
            <div class="bg-gradient-to-r from-red-500 to-purple-600 text-white rounded-2xl p-8 mb-8">
                <div class="text-6xl font-bold mb-2" id="hero-total-cost">$3.2T</div>
                <div class="text-2xl opacity-90">Annual Economic Impact</div>
                <div class="text-lg opacity-75 mt-2">
                    That's <span id="gdp-percentage">13.3%</span> of US GDP
                </div>
            </div>
        </section>

        <!-- Calculator Interface -->
        <section class="grid lg:grid-cols-2 gap-8 mb-12">
            
            <!-- Parameter Controls -->
            <div class="space-y-6">
                <h3 class="text-2xl font-semibold text-gray-900 mb-6">
                    Research Parameters
                </h3>
                
                <!-- Mortality Parameters -->
                <div class="bg-white rounded-lg p-6 shadow-sm parameter-group" data-group="mortality">
                    <h4 class="text-lg font-semibold text-red-700 mb-4">
                        ☠️ Mortality Costs
                    </h4>
                    
                    <!-- VSL Slider -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Value of Statistical Life
                            <button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-param="vsl" title="Show research">
                                ℹ️
                            </button>
                        </label>
                        <div id="vsl-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="vsl-value">$13.7M</div>
                        <div class="distribution-chart-container" data-parameter="vsl">
                            <svg id="vsl-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="vsl-stats">Mean: $13.7M | 95% CI: [$10.2M, $17.8M]</div>
                        </div>
                    </div>
                    
                    <!-- Excess Deaths Slider -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Excess Deaths Since 2009
                            <button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-param="suicides" title="Show research">
                                ℹ️
                            </button>
                        </label>
                        <div id="suicides-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="suicides-value">110K</div>
                        <div class="distribution-chart-container" data-parameter="suicides">
                            <svg id="suicides-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="suicides-stats">Mean: 110K | 95% CI: [89K, 140K]</div>
                        </div>
                    </div>
                    
                    <!-- Attribution Slider -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Attribution to Social Media
                            <button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-param="attribution" title="Show research">
                                ℹ️
                            </button>
                        </label>
                        <div id="attribution-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="attribution-value">18%</div>
                        <div class="distribution-chart-container" data-parameter="attribution">
                            <svg id="attribution-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="attribution-stats">Mean: 18% | 95% CI: [12%, 25%]</div>
                        </div>
                    </div>
                </div>
                
                <!-- Mental Health Parameters -->
                <div class="bg-white rounded-lg p-6 shadow-sm parameter-group" data-group="mental-health">
                    <h4 class="text-lg font-semibold text-purple-700 mb-4">
                        🧠 Mental Health Costs
                    </h4>
                    
                    <!-- Affected Population -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            People with SM-Induced Depression
                            <button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-param="depression" title="Show research">
                                ℹ️
                            </button>
                        </label>
                        <div id="depression-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="depression-value">5.0M</div>
                        <div class="distribution-chart-container" data-parameter="depression">
                            <svg id="depression-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="depression-stats">Mean: 5.0M | 95% CI: [3.5M, 8.0M]</div>
                        </div>
                    </div>
                    
                    <!-- Years Lived with Disability -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Years Lived with Disability
                            <button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-param="yld" title="Show research">
                                ℹ️
                            </button>
                        </label>
                        <div id="yld-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="yld-value">6.0 years</div>
                        <div class="distribution-chart-container" data-parameter="yld">
                            <svg id="yld-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="yld-stats">Mean: 6.0yr | 95% CI: [4.8yr, 7.5yr]</div>
                        </div>
                    </div>
                    
                    <!-- Quality of Life Impact -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Quality of Life Reduction
                            <button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-param="qol" title="Show research">
                                ℹ️
                            </button>
                        </label>
                        <div id="qol-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="qol-value">35%</div>
                        <div class="distribution-chart-container" data-parameter="qol">
                            <svg id="qol-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="qol-stats">Mean: 35% | 95% CI: [31%, 47%]</div>
                        </div>
                    </div>
                </div>
                
                <!-- Economic Parameters -->
                <div class="bg-white rounded-lg p-6 shadow-sm parameter-group" data-group="healthcare">
                    <h4 class="text-lg font-semibold text-green-700 mb-4">
                        💰 Economic Costs
                    </h4>
                    
                    <!-- Healthcare Costs -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Annual Healthcare Cost per Person
                            <button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-param="healthcare" title="Show research">
                                ℹ️
                            </button>
                        </label>
                        <div id="healthcare-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="healthcare-value">$7K</div>
                        <div class="distribution-chart-container" data-parameter="healthcare">
                            <svg id="healthcare-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="healthcare-stats">Mean: $7K | 95% CI: [$6.5K, $12K]</div>
                        </div>
                    </div>
                    
                    <!-- Productivity Loss -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Annual Productivity Loss per Person
                            <button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-param="productivity" title="Show research">
                                ℹ️
                            </button>
                        </label>
                        <div id="productivity-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="productivity-value">$6K</div>
                        <div class="distribution-chart-container" data-parameter="productivity">
                            <svg id="productivity-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="productivity-stats">Mean: $6K | 95% CI: [$4.8K, $8.5K]</div>
                        </div>
                    </div>
                    
                    <!-- Treatment Duration -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Average Treatment Duration
                            <button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-param="duration" title="Show research">
                                ℹ️
                            </button>
                        </label>
                        <div id="duration-nouislider" class="mb-2"></div>
                        <div class="text-right text-sm font-medium" id="duration-value">4.5 years</div>
                        <div class="distribution-chart-container" data-parameter="duration">
                            <svg id="duration-distribution" class="distribution-chart"></svg>
                            <div class="distribution-stats" id="duration-stats">Mean: 4.5yr | 95% CI: [3.0yr, 6.8yr]</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Display -->
            <div class="space-y-6">
                <h3 class="text-2xl font-semibold text-gray-900 mb-6">
                    Economic Impact Results
                </h3>
                
                <!-- Formula Results -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="text-lg font-semibold mb-4">Cost Breakdown</h4>
                    
                    <div class="mb-4 p-4 bg-red-50 rounded-lg">
                        <div class="font-medium text-red-700">Mortality Costs</div>
                        <div class="text-sm text-gray-600" id="mortality-result">
                            110K × 18% × $13.7M = $271B
                        </div>
                    </div>
                    
                    <div class="mb-4 p-4 bg-purple-50 rounded-lg">
                        <div class="font-medium text-purple-700">Mental Health Costs</div>
                        <div class="text-sm text-gray-600" id="mental-result">
                            5.0M × 6.0 × 35% × $183K = $1.9T
                        </div>
                    </div>
                    
                    <div class="mb-4 p-4 bg-green-50 rounded-lg">
                        <div class="font-medium text-green-700">Economic Costs</div>
                        <div class="text-sm text-gray-600" id="healthcare-result">
                            5.0M × ($7K + $6K) × 4.5 = $293B
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="text-2xl font-bold">
                            Total: <span id="total-cost">$3.2T</span>
                        </div>
                    </div>
                </div>
                
                <!-- Scenario Buttons -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="text-lg font-semibold mb-4">Research Scenarios</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="scenario-btn px-4 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors" data-scenario="reset">
                            🔬 Research Consensus
                        </button>
                        <button class="scenario-btn px-4 py-2 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" data-scenario="optimistic">
                            🌟 Most Optimistic
                        </button>
                        <button class="scenario-btn px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors" data-scenario="aggressive">
                            🚨 Worst Case
                        </button>
                        <button class="scenario-btn px-4 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors" data-scenario="facebookFiles">
                            📱 Facebook Files
                        </button>
                    </div>
                </div>
                
                <!-- Research Charts -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="text-lg font-semibold mb-4">Impact Visualization</h4>
                    <canvas id="breakdown-chart" width="400" height="200"></canvas>
                </div>
            </div>
        </section>

        <!-- Share Section -->
        <section class="text-center">
            <h3 class="text-2xl font-semibold text-gray-900 mb-6">
                Share These Findings
            </h3>
            <div class="flex justify-center space-x-4">
                <button id="share-twitter" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    Share on Twitter
                </button>
                <button id="share-linkedin" class="px-6 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors">
                    Share on LinkedIn
                </button>
                <button id="share-facebook" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Share on Facebook
                </button>
            </div>
        </section>
    </main>

    <!-- Research Modal -->
    <div id="research-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="modal-header p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-900">Parameter Research</h2>
                    <button id="modal-close" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
            </div>
            <div class="modal-body p-6">
                <div id="modal-description" class="mb-4 text-gray-600"></div>
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">Evidence Range</h3>
                        <div id="modal-evidence-range" class="text-blue-700"></div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-2">Current Value</h3>
                        <div id="modal-current-value" class="text-green-700 text-lg font-bold"></div>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold mb-4">Supporting Research</h3>
                <div id="modal-studies" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12 mt-16">
        <div class="max-w-7xl mx-auto px-4">
            <div class="text-center">
                <p class="text-gray-300">
                    Built using peer-reviewed research and federal agency methodologies
                </p>
                <p class="text-gray-400 text-sm mt-2">
                    &copy; 2024 Social Media Cost Calculator. Open source research project.
                </p>
            </div>
        </div>
    </footer>

    <!-- Error Handling & Initialization -->
    <script>
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            document.getElementById('error-banner').classList.add('show');
        });
        
        // Library loading verification
        let librariesLoaded = {
            tailwind: false,
            nouislider: false,
            chartjs: false,
            d3: false
        };
        
        // Check library loading
        function checkLibraries() {
            librariesLoaded.tailwind = typeof window.tailwind !== 'undefined' || document.querySelector('.bg-gray-50') !== null;
            librariesLoaded.nouislider = typeof noUiSlider !== 'undefined';
            librariesLoaded.chartjs = typeof Chart !== 'undefined';
            librariesLoaded.d3 = typeof d3 !== 'undefined';
            
            console.log('📚 Libraries loaded:', librariesLoaded);
            
            // Show warnings for missing libraries
            const missing = Object.entries(librariesLoaded).filter(([key, loaded]) => !loaded);
            if (missing.length > 0) {
                console.warn('⚠️ Missing libraries:', missing.map(([key]) => key));
            }
        }
        
        // Initialize with timeout
        let initTimeout;
        function attemptInitialization() {
            clearTimeout(initTimeout);
            checkLibraries();
            
            // Wait a bit more if libraries are still loading
            if (!librariesLoaded.nouislider || !librariesLoaded.d3) {
                console.log('⏳ Waiting for libraries to load...');
                initTimeout = setTimeout(attemptInitialization, 500);
                return;
            }
            
            // Hide loading screen
            document.getElementById('loading-screen').classList.add('hidden');
            
            // Initialize the calculator app
            if (typeof window.socialMediaApp !== 'undefined') {
                console.log('✅ Calculator already initialized');
            }
        }
        
        // Start checking after a short delay
        setTimeout(attemptInitialization, 100);
    </script>

    <!-- Modular JavaScript -->
    <script type="module" src="src/main.js"></script>

    <!-- Working Calculator Implementation -->
    <script>
        // Research Citations Database (inline for simplicity)
        const RESEARCH_CITATIONS = {
            vsl: {
                name: "Value of Statistical Life",
                unit: "$ millions",
                description: "Economic value assigned to preventing one statistical death, used in policy analysis.",
                defaultValue: 13.7,
                evidenceRange: { min: 7.0, max: 14.0, confidence: "High" },
                studies: [
                    {
                        title: "DOT VSL Guidance Update (2024)",
                        authors: "U.S. Department of Transportation",
                        value: "$13.7 million",
                        confidence: "Very High",
                        url: "https://www.transportation.gov/office-policy/transportation-policy/revised-departmental-guidance-on-valuation-of-a-statistical-life-in-economic-analysis",
                        quote: "Central VSL estimate for 2024 economic analysis"
                    },
                    {
                        title: "EPA VSL Guidance Update (2023)",
                        authors: "U.S. Environmental Protection Agency",
                        value: "$10.9 million base year, $12.8M in 2023 dollars",
                        confidence: "Very High",
                        url: "https://www.epa.gov/environmental-economics/mortality-risk-valuation",
                        quote: "EPA's current central estimate for VSL in regulatory analysis"
                    },
                    {
                        title: "VSL Meta-Analysis of Meta-Analyses",
                        authors: "Viscusi, Aldy, Banzhaf",
                        value: "$7.0-8.0 million central range",
                        confidence: "Very High",
                        url: "https://www.nber.org/papers/w29185",
                        quote: "The value of statistical life: a meta-analysis of meta-analyses"
                    }
                ]
            },
            attribution: {
                name: "Attribution to Social Media",
                unit: "%",
                description: "Percentage of mental health impacts causally attributable to social media.",
                defaultValue: 18,
                evidenceRange: { min: 7, max: 22, confidence: "High" },
                studies: [
                    {
                        title: "Social Media and Mental Health",
                        authors: "Braghieri, Levy, Makarin",
                        value: "9% depression increase",
                        confidence: "Very High",
                        url: "https://www.aeaweb.org/articles?id=10.1257/aer.20211218",
                        quote: "Facebook rollout caused 9% increase in depression"
                    },
                    {
                        title: "Surgeon General Advisory",
                        authors: "U.S. Surgeon General",
                        value: "2× risk for >3 hours daily",
                        confidence: "High",
                        url: "https://www.hhs.gov/sites/default/files/sg-youth-mental-health-social-media-advisory.pdf",
                        quote: "Double risk of depression with >3 hours daily use"
                    },
                    {
                        title: "Facebook Files Internal Research",
                        authors: "Haugen Whistleblower Documents",
                        value: "13.5% teen girls: Instagram makes depression worse",
                        confidence: "High",
                        url: "https://www.wsj.com/articles/facebook-knows-instagram-is-toxic-for-teen-girls-company-documents-show-11631620739",
                        quote: "We make body image issues worse for one in three teen girls"
                    },
                    {
                        title: "Systematic Review of Social Media and Suicide Risk",
                        authors: "Sedgwick R, Epstein S, Dutta R, et al.",
                        value: "25-30% higher suicide risk with heavy social media use",
                        confidence: "High",
                        url: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6477579/",
                        quote: "Heavy social media use associated with 25-30% increased suicide ideation and attempts"
                    }
                ]
            },
            suicides: {
                name: "Excess Deaths Since 2009",
                unit: "deaths",
                description: "Additional suicide deaths beyond baseline trends since social media mass adoption (2009-2012).",
                defaultValue: 110000,
                evidenceRange: { min: 60000, max: 120000, confidence: "High" },
                studies: [
                    {
                        title: "CDC Suicide Data and Statistics",
                        authors: "Centers for Disease Control",
                        value: "49,000+ annual deaths, 37% rate increase 2000-2018",
                        confidence: "High",
                        url: "https://www.cdc.gov/suicide/facts/data.html",
                        quote: "Youth suicide rates: 10.7 per 100,000 (2007) → 17.4 per 100,000 (2021)"
                    },
                    {
                        title: "A nationwide study on social media and self-harm",
                        authors: "Tormoen et al.",
                        value: "OR = 2.74 crude, OR = 1.49 adjusted for >3h/day",
                        confidence: "High",
                        url: "https://www.nature.com/articles/s41598-023-46370-y",
                        quote: "Significant association between social media use and self-harm behaviors"
                    },
                    {
                        title: "CDC Youth Suicide Surveillance",
                        authors: "Centers for Disease Control and Prevention",
                        value: "Youth suicide rate: 62% increase 2007-2021 (10.7→17.4 per 100K)",
                        confidence: "Very High",
                        url: "https://www.cdc.gov/nchs/data/databriefs/db433.pdf",
                        quote: "Suicide rates among youth aged 10-24 increased 62% from 2007 to 2021, coinciding with social media adoption"
                    }
                ]
            },
            depression: {
                name: "People with SM-Induced Depression",
                unit: "millions",
                description: "Number of depression cases directly attributable to social media exposure, not total depression.",
                defaultValue: 5.0,
                evidenceRange: { min: 2.0, max: 8.0, confidence: "High" },
                studies: [
                    {
                        title: "Social Media Use and Depressive Symptoms During Early Adolescence",
                        authors: "Nagata JM, Otmar CD, Shim J, et al.",
                        value: "Increased SM use → higher depression symptoms",
                        confidence: "High",
                        url: "https://www.ajmc.com/view/increased-social-media-use-linked-to-rising-depressive-symptoms-in-early-adolescents",
                        quote: "Within-person increases in social media use were significantly associated with greater depressive symptoms a year later"
                    },
                    {
                        title: "Association between Social Media Use and Depression among U.S. Young Adults",
                        authors: "Lin LY, Sidani JE, Shensa A, et al.",
                        value: "AOR=1.66-3.05 for highest SM use quartiles",
                        confidence: "High",
                        url: "https://pmc.ncbi.nlm.nih.gov/articles/PMC4853817/",
                        quote: "Participants in the highest quartile had significantly increased odds of depression (AOR=1.66-3.05) after controlling for all covariates"
                    }
                ]
            },
            yld: {
                name: "Years Lived with Disability",
                unit: "years",
                description: "Average duration of depression episode per person affected by social media.",
                defaultValue: 6.0,
                evidenceRange: { min: 4.8, max: 7.5, confidence: "High" },
                studies: [
                    {
                        title: "Depression prevalence estimates",
                        authors: "Global Burden of Disease Study",
                        value: "51.84 million DALYs globally",
                        confidence: "High",
                        url: "https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(21)02143-7/fulltext",
                        quote: "Depression accounts for 27.6% of years lived with disability for mental disorders"
                    },
                    {
                        title: "Clinical episode duration studies",
                        authors: "Spijker et al.",
                        value: "Median episode 3 months; 20% still depressed at 24 months",
                        confidence: "High",
                        url: "https://pubmed.ncbi.nlm.nih.gov/12204924/",
                        quote: "Natural history of depression shows variable episode duration"
                    },
                    {
                        title: "Global Burden of Disease Study 2019",
                        authors: "GBD 2019 Mental Disorders Collaborators",
                        value: "Depression: 46.9 million DALYs globally (average 6.2 years per case)",
                        confidence: "Very High",
                        url: "https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(21)02143-7/fulltext",
                        quote: "Major depressive disorder was responsible for 46.9 million disability-adjusted life years globally"
                    }
                ]
            },
            qol: {
                name: "Quality of Life Reduction",
                unit: "%",
                description: "Percentage reduction in quality-adjusted life years (QALYs) for those with social media-induced depression.",
                defaultValue: 35,
                evidenceRange: { min: 31, max: 47, confidence: "High" },
                studies: [
                    {
                        title: "Population quality of life norms",
                        authors: "Singapore SF-6D Study",
                        value: "Mean baseline score 0.87, depression reduces to ~0.52",
                        confidence: "High",
                        url: "https://link.springer.com/article/10.1007/s11136-017-1585-3",
                        quote: "Depression associated with 40% reduction in health utility scores"
                    },
                    {
                        title: "Utility loss per depressed adult",
                        authors: "Lamers et al.",
                        value: "~0.41 QALYs per depressed adult",
                        confidence: "High",
                        url: "https://pmc.ncbi.nlm.nih.gov/articles/PMC4590980/",
                        quote: "Substantial quality of life impairment associated with major depression"
                    },
                    {
                        title: "Health-Related Quality of Life in Depression",
                        authors: "Rapaport MH, Clary C, Fayyad R, et al.",
                        value: "30-50% reduction in quality of life measures",
                        confidence: "High",
                        url: "https://pubmed.ncbi.nlm.nih.gov/15841781/",
                        quote: "Major depression associated with 30-50% reduction in quality of life across multiple domains"
                    }
                ]
            },
            healthcare: {
                name: "Annual Healthcare Cost per Person",
                unit: "$ thousands",
                description: "Annual healthcare expenditure per person with social media-induced depression.",
                defaultValue: 7.0,
                evidenceRange: { min: 6.5, max: 12.0, confidence: "High" },
                studies: [
                    {
                        title: "Healthcare costs of depression",
                        authors: "Healthcare Cost Institute",
                        value: "$10,836 annual cost per MDD patient",
                        confidence: "High",
                        url: "https://www.psychiatrist.com/jcp/depression/major-depressive-disorder/economic-burden-depression/",
                        quote: "Direct medical costs significantly elevated for patients with major depression"
                    },
                    {
                        title: "Economic Burden of Major Depressive Disorder",
                        authors: "Greenberg PE, Fournier AA, Sisitsky T, et al.",
                        value: "$326 billion total economic burden (2018)",
                        confidence: "High",
                        url: "https://pmc.ncbi.nlm.nih.gov/articles/PMC10499687/",
                        quote: "Total economic burden increased from $236B (2010) to $326B (2018), driven by workplace costs"
                    },
                    {
                        title: "Direct Medical Costs of Depression Treatment",
                        authors: "Basu A, Ganoczy D, Simonetti J, et al.",
                        value: "$8,000-12,000 annual direct medical costs per patient",
                        confidence: "High",
                        url: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6430527/",
                        quote: "Average annual direct medical costs range $8,000-12,000 per patient with major depression"
                    }
                ]
            },
            productivity: {
                name: "Annual Productivity Loss per Person",
                unit: "$ thousands",
                description: "Annual workplace productivity loss per person with social media-induced depression.",
                defaultValue: 6.0,
                evidenceRange: { min: 4.8, max: 8.5, confidence: "High" },
                studies: [
                    {
                        title: "Workplace impact of depression",
                        authors: "Economic Burden Studies",
                        value: "$187.8 billion annual employer costs",
                        confidence: "High",
                        url: "https://pubmed.ncbi.nlm.nih.gov/12813119/",
                        quote: "$44 billion US work-time loss per year from depression"
                    },
                    {
                        title: "Mental health at work",
                        authors: "World Health Organization",
                        value: "12 billion workdays lost; $1T global productivity loss",
                        confidence: "High",
                        url: "https://www.who.int/news-room/fact-sheets/detail/mental-health-at-work",
                        quote: "Depression and anxiety disorders cost the global economy $1 trillion per year in lost productivity"
                    },
                    {
                        title: "Workplace Productivity Loss from Depression",
                        authors: "Stewart WF, Ricci JA, Chee E, et al.",
                        value: "$5,000-9,000 annual productivity loss per employee",
                        confidence: "High",
                        url: "https://pubmed.ncbi.nlm.nih.gov/12813119/",
                        quote: "Depression results in $5,000-9,000 annual productivity loss per affected employee through absenteeism and presenteeism"
                    }
                ]
            },
            duration: {
                name: "Average Treatment Duration",
                unit: "years",
                description: "Average duration of treatment and productivity impact per depression episode.",
                defaultValue: 4.5,
                evidenceRange: { min: 3.0, max: 6.8, confidence: "High" },
                studies: [
                    {
                        title: "Treatment guidelines",
                        authors: "Medscape Clinical Guidelines",
                        value: "6–12 weeks acute; 4–9 months maintenance",
                        confidence: "High",
                        url: "https://emedicine.medscape.com/article/286759-treatment",
                        quote: "Standard treatment duration for major depressive episodes"
                    },
                    {
                        title: "Long-term outcomes study",
                        authors: "Spijker et al.",
                        value: "20% still depressed at 24 months",
                        confidence: "High",
                        url: "https://pubmed.ncbi.nlm.nih.gov/12204924/",
                        quote: "Substantial proportion experience prolonged episodes"
                    },
                    {
                        title: "Economic Burden Treatment Duration Analysis",
                        authors: "Crown WH, Finkelstein S, Berndt ER, et al.",
                        value: "Average treatment duration: 3.9 years for recurrent episodes",
                        confidence: "High",
                        url: "https://pubmed.ncbi.nlm.nih.gov/12005119/",
                        quote: "Patients with recurrent depression had average treatment duration of 3.9 years"
                    }
                ]
            }
        };
        
        // Working Calculator Class from v5
        class SocialMediaCalculator {
            constructor() {
                this.parameters = {
                    vsl: 13.7,
                    suicides: 110000,
                    attribution: 18,
                    depression: 5000000,
                    yld: 6.0,
                    qol: 35,
                    healthcare: 7000,
                    productivity: 6000,
                    duration: 4.5
                };
                
                // Updated scenarios to fit within evidence-based ranges
                this.scenarios = {
                    reset: { vsl: 13.7, suicides: 110000, attribution: 18, depression: 5000000, yld: 6.0, qol: 35, healthcare: 7000, productivity: 6000, duration: 4.5 },
                    aggressive: { vsl: 14.0, suicides: 120000, attribution: 22, depression: 8000000, yld: 7.5, qol: 47, healthcare: 12000, productivity: 8500, duration: 6.8 },
                    facebookFiles: { vsl: 13.7, suicides: 110000, attribution: 22, depression: 8000000, yld: 6.5, qol: 38, healthcare: 10000, productivity: 7500, duration: 5.2 },
                    optimistic: { vsl: 7.0, suicides: 60000, attribution: 7, depression: 2000000, yld: 4.8, qol: 31, healthcare: 6500, productivity: 4800, duration: 3.0 }
                };
                
                // Performance optimizations
                this.updateTimeouts = {};
                this.chartCache = new Map();
                this.lastResults = null;
                this.animationFrameId = null;
                
                this.init();
            }
            
            init() {
                console.log('🚀 Initializing calculator...');
                this.setupSliders();
                this.setupScenarioButtons();
                this.setupDistributionCharts();
                this.setupShareButtons();
                this.setupResearchModal();
                this.updateAllDisplays();
                console.log('✅ Calculator initialized successfully');
            }
            
            setupSliders() {
                if (typeof noUiSlider === 'undefined') {
                    console.warn('noUiSlider not available, waiting...');
                    setTimeout(() => this.setupSliders(), 100);
                    return;
                }
                
                // Evidence-based ranges from peer-reviewed research
                const sliderConfigs = {
                    'vsl': { range: { min: 7.0, max: 14.0 }, start: 13.7, step: 0.1 },
                    'suicides': { range: { min: 60000, max: 120000 }, start: 110000, step: 1000 },
                    'attribution': { range: { min: 7, max: 22 }, start: 18, step: 1 },
                    'depression': { range: { min: 2000000, max: 8000000 }, start: 5000000, step: 100000 },
                    'yld': { range: { min: 4.8, max: 7.5 }, start: 6.0, step: 0.1 },
                    'qol': { range: { min: 31, max: 47 }, start: 35, step: 1 },
                    'healthcare': { range: { min: 6500, max: 12000 }, start: 7000, step: 100 },
                    'productivity': { range: { min: 4800, max: 8500 }, start: 6000, step: 100 },
                    'duration': { range: { min: 3.0, max: 6.8 }, start: 4.5, step: 0.1 }
                };
                
                Object.keys(sliderConfigs).forEach(param => {
                    this.createSlider(param, sliderConfigs[param]);
                });
                
                console.log('✅ Sliders initialized');
            }
            
            createSlider(param, config) {
                const container = document.getElementById(`${param}-nouislider`);
                if (!container) {
                    console.warn(`Container for ${param} not found`);
                    return;
                }
                
                try {
                    noUiSlider.create(container, {
                        range: config.range,
                        start: config.start,
                        step: config.step,
                        connect: 'lower',
                        tooltips: {
                            to: (value) => this.formatParameter(param, value),
                            from: (value) => Number(value)
                        }
                    });
                    
                    container.noUiSlider.on('update', (values, handle) => {
                        const value = parseFloat(values[handle]);
                        this.parameters[param] = value;
                        this.updateDisplay(param, value);
                        
                        // Debounced chart updates for performance
                        this.debouncedChartUpdate(param);
                    });
                    
                    container.noUiSlider.on('change', () => {
                        // Immediate calculation update
                        this.updateAllDisplays();
                    });
                    
                    console.log(`✅ Created slider for ${param}`);
                    
                } catch (error) {
                    console.error(`Failed to create slider for ${param}:`, error);
                }
            }
            
            setupScenarioButtons() {
                const scenarioButtons = document.querySelectorAll('.scenario-btn');
                scenarioButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const scenario = e.target.dataset.scenario;
                        this.loadScenario(scenario);
                        console.log(`✅ Loaded scenario: ${scenario}`);
                    });
                });
                console.log('✅ Scenario buttons initialized');
            }
            
            loadScenario(scenarioName) {
                const scenario = this.scenarios[scenarioName];
                if (!scenario) return;
                
                console.log(`🎯 Loading scenario: ${scenarioName}`, scenario);
                
                Object.keys(scenario).forEach(param => {
                    this.parameters[param] = scenario[param];
                    
                    // Update slider with animation
                    const container = document.getElementById(`${param}-nouislider`);
                    if (container && container.noUiSlider) {
                        container.noUiSlider.set(scenario[param], true); // true = fire events
                    }
                    
                    this.updateDisplay(param, scenario[param]);
                });
                
                // Force update all distribution charts after a short delay
                setTimeout(() => {
                    Object.keys(scenario).forEach(param => {
                        this.updateDistributionChart(param); // This recreates curves
                    });
                }, 100);
                
                this.updateAllDisplays();
                console.log(`✅ Scenario ${scenarioName} loaded successfully`);
            }
            
            setupDistributionCharts() {
                if (typeof d3 === 'undefined') {
                    console.warn('D3.js not available, skipping distribution charts');
                    return;
                }
                
                const parameters = ['vsl', 'suicides', 'attribution', 'depression', 'yld', 'qol', 'healthcare', 'productivity', 'duration'];
                parameters.forEach(param => {
                    this.createDistributionChart(param);
                    this.updateDistributionStats(param);
                });
                
                console.log('✅ Distribution charts initialized');
                
                // Add resize listener for responsive charts
                this.setupResponsiveCharts();
            }
            
            setupResponsiveCharts() {
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        console.log('📊 Resizing distribution charts for new viewport');
                        const parameters = ['vsl', 'suicides', 'attribution', 'depression', 'yld', 'qol', 'healthcare', 'productivity', 'duration'];
                        parameters.forEach(param => {
                            this.createDistributionChart(param);
                        });
                    }, 250); // Debounce resize events
                });
                
                console.log('✅ Responsive chart resize listener added');
            }
            
            createDistributionChart(param) {
                const container = document.getElementById(`${param}-distribution`);
                if (!container) return;
                
                // Get the actual container width dynamically
                const containerWidth = container.parentElement.clientWidth || container.parentElement.offsetWidth;
                const width = Math.max(containerWidth - 20, 250); // Subtract padding, minimum 250px
                
                console.log(`📏 ${param} chart: container=${containerWidth}px, chart=${width}px`);
                const height = 60;
                const margin = { top: 5, right: 5, bottom: 5, left: 5 };
                
                // Clear existing
                d3.select(container).selectAll('*').remove();
                
                const svg = d3.select(container)
                    .attr('width', width)
                    .attr('height', height)
                    .attr('viewBox', `0 0 ${width} ${height}`)
                    .style('width', '100%')
                    .style('height', `${height}px`);
                
                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);
                
                // Generate curve data
                const data = this.generateCurveData(param);
                
                const xScale = d3.scaleLinear()
                    .domain(d3.extent(data, d => d.x))
                    .range([0, width - margin.left - margin.right]);
                
                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.y)])
                    .range([height - margin.top - margin.bottom, 0]);
                
                const line = d3.line()
                    .x(d => xScale(d.x))
                    .y(d => yScale(d.y))
                    .curve(d3.curveCardinal);
                
                const area = d3.area()
                    .x(d => xScale(d.x))
                    .y0(yScale(0))
                    .y1(d => yScale(d.y))
                    .curve(d3.curveCardinal);
                
                // Get colors
                const colors = this.getParameterColors(param);
                
                // Draw area
                g.append('path')
                    .datum(data)
                    .attr('class', 'distribution-fill')
                    .attr('d', area)
                    .style('fill', colors.fill)
                    .style('opacity', 0.6);
                
                // Draw line
                g.append('path')
                    .datum(data)
                    .attr('class', 'distribution-path')
                    .attr('d', line)
                    .style('fill', 'none')
                    .style('stroke', colors.stroke)
                    .style('stroke-width', 2);
                
                // Add current value indicator
                this.addCurrentValueIndicator(g, param, xScale, yScale);
            }
            
            generateCurveData(param) {
                const config = this.getParameterConfig(param);
                const currentValue = this.parameters[param]; // Use current parameter value as center
                const data = [];
                const numPoints = 50;
                
                for (let i = 0; i <= numPoints; i++) {
                    const x = config.min + (config.max - config.min) * (i / numPoints);
                    let y;
                    
                    if (config.type === 'normal') {
                        // Normal distribution centered on current value
                        const variance = config.std * config.std;
                        const exponent = -0.5 * Math.pow((x - currentValue) / config.std, 2);
                        y = Math.exp(exponent) / (config.std * Math.sqrt(2 * Math.PI));
                    } else {
                        // Skewed distribution with peak near current value
                        const shift = currentValue / config.mean; // Scale factor
                        const adjustedMean = currentValue;
                        const logX = Math.log(Math.max(x, 1));
                        const logMean = Math.log(Math.max(adjustedMean, 1));
                        const logStd = 0.4;
                        const exponent = -0.5 * Math.pow((logX - logMean) / logStd, 2);
                        y = Math.exp(exponent) / (Math.max(x, 1) * logStd * Math.sqrt(2 * Math.PI));
                    }
                    
                    data.push({ x, y });
                }
                
                return data;
            }
            
            getParameterConfig(param) {
                // Evidence-based distribution parameters from research citations
                const configs = {
                    vsl: { type: 'normal', min: 7.0, max: 14.0, mean: 13.7, std: 1.4 },
                    suicides: { type: 'skewed', min: 60000, max: 120000, mean: 110000, std: 15000 },
                    attribution: { type: 'normal', min: 7, max: 22, mean: 18, std: 3.5 },
                    depression: { type: 'skewed', min: 2000000, max: 8000000, mean: 5000000, std: 1500000 },
                    yld: { type: 'normal', min: 4.8, max: 7.5, mean: 6.0, std: 0.7 },
                    qol: { type: 'normal', min: 31, max: 47, mean: 35, std: 4 },
                    healthcare: { type: 'skewed', min: 6500, max: 12000, mean: 7000, std: 1500 },
                    productivity: { type: 'skewed', min: 4800, max: 8500, mean: 6000, std: 900 },
                    duration: { type: 'normal', min: 3.0, max: 6.8, mean: 4.5, std: 0.9 }
                };
                return configs[param];
            }
            
            getParameterColors(param) {
                const mortalityParams = ['vsl', 'suicides', 'attribution'];
                const mentalHealthParams = ['depression', 'yld', 'qol'];
                const economicParams = ['healthcare', 'productivity', 'duration'];
                
                if (mortalityParams.includes(param)) {
                    return { stroke: '#dc2626', fill: 'rgba(220, 38, 38, 0.1)' };
                } else if (mentalHealthParams.includes(param)) {
                    return { stroke: '#8b5cf6', fill: 'rgba(139, 92, 246, 0.1)' };
                } else {
                    return { stroke: '#10b981', fill: 'rgba(16, 185, 129, 0.1)' };
                }
            }
            
            addCurrentValueIndicator(g, param, xScale, yScale) {
                const currentValue = this.parameters[param];
                const config = this.getParameterConfig(param);
                
                // For normal distributions, peak is at current value
                // For skewed distributions, find the actual peak
                let peakValue = currentValue;
                
                if (config.type === 'skewed') {
                    // For log-normal distributions, the mode is slightly left of the mean
                    const logStd = 0.4;
                    peakValue = currentValue * Math.exp(-logStd * logStd);
                    // Ensure peak stays within bounds
                    peakValue = Math.max(config.min, Math.min(config.max, peakValue));
                }
                
                const x = xScale(peakValue);
                
                g.append('line')
                    .attr('class', 'current-value-line')
                    .attr('x1', x)
                    .attr('x2', x)
                    .attr('y1', 0)
                    .attr('y2', yScale.range()[0])
                    .style('stroke', '#ef4444')
                    .style('stroke-width', 2)
                    .style('stroke-dasharray', '3,3');
                
                g.append('circle')
                    .attr('class', 'current-value-dot')
                    .attr('cx', x)
                    .attr('cy', 5)
                    .attr('r', 3)
                    .style('fill', '#ef4444')
                    .style('stroke', '#ffffff')
                    .style('stroke-width', 1);
                
                console.log(`📊 ${param} curve peak at ${peakValue.toFixed(2)} (current: ${currentValue})`);
            }
            
            updateDistributionChart(param) {
                // Recreate the entire chart with new curve shape
                this.createDistributionChart(param);
                
                // Update distribution statistics
                this.updateDistributionStats(param);
            }
            
            updateCurrentValueIndicator(param) {
                const container = document.getElementById(`${param}-distribution`);
                if (!container) return;
                
                const svg = d3.select(container);
                const currentValue = this.parameters[param];
                const config = this.getParameterConfig(param);
                
                // Calculate chart dimensions (same as createDistributionChart)
                const containerWidth = container.parentElement.clientWidth || container.parentElement.offsetWidth;
                const width = Math.max(containerWidth - 20, 250); // Subtract padding, minimum 250px
                const height = 60;
                const margin = { top: 5, right: 5, bottom: 5, left: 5 };
                
                const xScale = d3.scaleLinear()
                    .domain([config.min, config.max])
                    .range([0, width - margin.left - margin.right]);
                
                // Calculate peak position (same logic as addCurrentValueIndicator)
                let peakValue = currentValue;
                if (config.type === 'skewed') {
                    const logStd = 0.4;
                    peakValue = currentValue * Math.exp(-logStd * logStd);
                    peakValue = Math.max(config.min, Math.min(config.max, peakValue));
                }
                
                const x = xScale(peakValue);
                
                // Remove existing current value indicators
                svg.selectAll('.current-value-line, .current-value-dot').remove();
                
                // Add updated current value line and dot
                const g = svg.select('g');
                if (g.empty()) return;
                
                g.append('line')
                    .attr('class', 'current-value-line')
                    .attr('x1', x)
                    .attr('x2', x)
                    .attr('y1', 0)
                    .attr('y2', height - margin.top - margin.bottom)
                    .style('stroke', '#ef4444')
                    .style('stroke-width', 2)
                    .style('stroke-dasharray', '3,3')
                    .style('opacity', 0)
                    .transition()
                    .duration(200)
                    .style('opacity', 1);
                
                g.append('circle')
                    .attr('class', 'current-value-dot')
                    .attr('cx', x)
                    .attr('cy', 5)
                    .attr('r', 0)
                    .style('fill', '#ef4444')
                    .style('stroke', '#ffffff')
                    .style('stroke-width', 1)
                    .transition()
                    .duration(200)
                    .attr('r', 3);
                
                console.log(`📊 Updated ${param} curve peak at ${peakValue.toFixed(2)} (current: ${currentValue})`);
            }
            
            updateDistributionStats(param) {
                const statsElement = document.getElementById(`${param}-stats`);
                if (!statsElement) return;
                
                const config = this.getParameterConfig(param);
                const currentValue = this.parameters[param];
                
                // Calculate 95% confidence interval
                const ciLow = config.type === 'normal' ? 
                    config.mean - (1.96 * config.std) : 
                    config.mean * 0.7;
                const ciHigh = config.type === 'normal' ? 
                    config.mean + (1.96 * config.std) : 
                    config.mean * 1.4;
                
                // Format the statistics text
                const meanText = this.formatParameter(param, currentValue);
                const ciLowText = this.formatParameter(param, Math.max(config.min, ciLow));
                const ciHighText = this.formatParameter(param, Math.min(config.max, ciHigh));
                
                statsElement.textContent = `Current: ${meanText} | 95% CI: [${ciLowText}, ${ciHighText}]`;
            }
            
            formatParameter(param, value) {
                const formatters = {
                    vsl: v => `$${v.toFixed(1)}M`,
                    suicides: v => `${Math.round(v/1000)}K`,
                    attribution: v => `${Math.round(v)}%`,
                    depression: v => `${(v/1000000).toFixed(1)}M`,
                    yld: v => `${v.toFixed(1)} years`,
                    qol: v => `${Math.round(v)}%`,
                    healthcare: v => `$${Math.round(v/1000)}K`,
                    productivity: v => `$${Math.round(v/1000)}K`,
                    duration: v => `${v.toFixed(1)} years`
                };
                return formatters[param] ? formatters[param](value) : value.toString();
            }
            
            updateDisplay(param, value) {
                const display = document.getElementById(`${param}-value`);
                if (display) {
                    display.textContent = this.formatParameter(param, value);
                }
            }
            
            calculateTotalEconomicImpact() {
                const { vsl, suicides, attribution, depression, yld, qol, healthcare, productivity, duration } = this.parameters;
                
                // Mortality costs
                const mortalityCosts = suicides * (attribution / 100) * vsl * 1000000;
                
                // Mental health costs
                const annualLifeValue = (vsl * 1000000) / 75;
                const mentalCosts = depression * yld * (qol / 100) * annualLifeValue;
                
                // Economic costs
                const economicCosts = depression * (healthcare + productivity) * duration;
                
                const total = mortalityCosts + mentalCosts + economicCosts;
                
                return {
                    mortality: mortalityCosts,
                    mental: mentalCosts,
                    productivity: economicCosts,
                    total
                };
            }
            
            formatLargeNumber(value) {
                if (value >= 1e12) {
                    return `$${(value / 1e12).toFixed(1)}T`;
                } else if (value >= 1e9) {
                    return `$${(value / 1e9).toFixed(1)}B`;
                } else if (value >= 1e6) {
                    return `$${(value / 1e6).toFixed(1)}M`;
                } else {
                    return `$${Math.round(value).toLocaleString()}`;
                }
            }
            
            updateAllDisplays() {
                // Use optimized version for better performance
                this.optimizedUpdateAllDisplays();
                
                console.log('✅ All displays updated (optimized)');
            }
            
            updateBreakdownChart(results) {
                const canvas = document.getElementById('breakdown-chart');
                if (!canvas || typeof Chart === 'undefined') return;
                
                // Destroy existing chart
                if (this.chart) {
                    this.chart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mortality Costs', 'Mental Health Costs', 'Economic Costs'],
                        datasets: [{
                            data: [results.mortality, results.mental, results.productivity],
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.8)',   // Red for mortality
                                'rgba(147, 51, 234, 0.8)',  // Purple for mental health
                                'rgba(34, 197, 94, 0.8)'    // Green for economic
                            ],
                            borderColor: [
                                'rgb(239, 68, 68)',
                                'rgb(147, 51, 234)',
                                'rgb(34, 197, 94)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = this.formatLargeNumber(context.raw);
                                        const percentage = ((context.raw / results.total) * 100).toFixed(1);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            setupShareButtons() {
                const shareButtons = {
                    'share-twitter': this.shareOnTwitter.bind(this),
                    'share-linkedin': this.shareOnLinkedIn.bind(this),
                    'share-facebook': this.shareOnFacebook.bind(this)
                };
                
                Object.keys(shareButtons).forEach(buttonId => {
                    const button = document.getElementById(buttonId);
                    if (button) {
                        button.addEventListener('click', shareButtons[buttonId]);
                    }
                });
            }
            
            shareOnTwitter() {
                const results = this.calculateTotalEconomicImpact();
                const text = `Social media's hidden cost: ${this.formatLargeNumber(results.total)} annually in economic damage. That's ${((results.total / 24e12) * 100).toFixed(1)}% of US GDP! 📊`;
                const url = encodeURIComponent(window.location.href);
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${url}`, '_blank');
            }
            
            shareOnLinkedIn() {
                const url = encodeURIComponent(window.location.href);
                const title = 'Social Media Economic Impact Calculator';
                const summary = 'Research-based analysis of social media\'s economic costs';
                window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}&title=${encodeURIComponent(title)}&summary=${encodeURIComponent(summary)}`, '_blank');
            }
            
            shareOnFacebook() {
                const url = encodeURIComponent(window.location.href);
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
            }
            
            setupResearchModal() {
                const modal = document.getElementById('research-modal');
                const modalClose = document.getElementById('modal-close');
                const infoButtons = document.querySelectorAll('.info-btn');
                
                // Info button click handlers
                infoButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const param = button.dataset.param;
                        this.showResearchModal(param);
                    });
                });
                
                // Modal close handlers
                modalClose.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
                
                // Keyboard close
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                    }
                });
                
                console.log('✅ Research modal initialized');
            }
            
            showResearchModal(param) {
                const research = RESEARCH_CITATIONS[param];
                if (!research) {
                    console.warn(`No research data found for parameter: ${param}`);
                    return;
                }
                
                const modal = document.getElementById('research-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalDescription = document.getElementById('modal-description');
                const modalEvidenceRange = document.getElementById('modal-evidence-range');
                const modalCurrentValue = document.getElementById('modal-current-value');
                const modalStudies = document.getElementById('modal-studies');
                
                // Update modal content
                modalTitle.textContent = research.name;
                modalDescription.innerHTML = `
                    <p class="text-lg">${research.description}</p>
                    <p class="mt-2 text-sm text-gray-500">Unit: ${research.unit}</p>
                `;
                
                modalEvidenceRange.innerHTML = `
                    <div class="text-lg font-bold">${research.evidenceRange.min} - ${research.evidenceRange.max} ${research.unit}</div>
                    <div class="text-sm">Confidence: ${research.evidenceRange.confidence}</div>
                `;
                
                const currentValue = this.parameters[param];
                modalCurrentValue.innerHTML = `
                    <div>${this.formatParameter(param, currentValue)}</div>
                    <div class="text-sm text-gray-600">Current calculator setting</div>
                `;
                
                // Populate studies with click-to-apply functionality
                modalStudies.innerHTML = research.studies.map((study, index) => {
                    const extractedValue = this.extractValueFromStudy(study, param);
                    const hasApplicableValue = extractedValue !== null;
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 study-entry ${hasApplicableValue ? 'cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-colors' : ''}" 
                             data-param="${param}" data-study-index="${index}" ${hasApplicableValue ? 'data-clickable="true"' : ''}>
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-lg">${study.title}</h4>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 text-xs rounded-full ${
                                        study.confidence === 'Very High' ? 'bg-green-100 text-green-800' :
                                        study.confidence === 'High' ? 'bg-blue-100 text-blue-800' :
                                        'bg-yellow-100 text-yellow-800'
                                    }">${study.confidence}</span>
                                    ${hasApplicableValue ? `
                                        <button class="apply-study-btn px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                            📊 Apply Value
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <p class="text-gray-600 mb-2">${study.authors}</p>
                            <p class="font-medium mb-2">Finding: ${study.value}</p>
                            ${hasApplicableValue ? `
                                <div class="bg-green-50 border border-green-200 rounded p-2 mb-2">
                                    <span class="text-green-700 text-sm font-medium">
                                        🎯 Applicable value: ${this.formatParameter(param, extractedValue)}
                                    </span>
                                </div>
                            ` : ''}
                            <blockquote class="italic text-gray-700 border-l-4 border-gray-300 pl-4 mb-3">
                                "${study.quote}"
                            </blockquote>
                            <a href="${study.url}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm">
                                📄 View Study →
                            </a>
                        </div>
                    `;
                }).join('');
                
                // Add click handlers for study application
                this.addStudyClickHandlers(param);
                
                // Show modal
                modal.classList.remove('hidden');
                
                console.log(`📚 Showing research for ${param}`);
            }
            
            extractValueFromStudy(study, param) {
                const value = study.value.toLowerCase();
                
                // Parameter-specific value extraction
                switch(param) {
                    case 'vsl':
                        // Extract VSL values like "$13.7 million", "$7.0-8.0 million"
                        const vslMatch = value.match(/\$(\d+\.?\d*)/);
                        return vslMatch ? parseFloat(vslMatch[1]) : null;
                        
                    case 'attribution':
                        // Extract percentages like "9%", "25-30%", "13.5%"
                        const percentMatch = value.match(/(\d+\.?\d*)%/);
                        return percentMatch ? parseFloat(percentMatch[1]) : null;
                        
                    case 'depression':
                        // Extract numbers with "aor=" or population counts
                        if (value.includes('aor=')) {
                            const aorMatch = value.match(/aor=(\d+\.?\d*)/);
                            if (aorMatch) {
                                // Convert AOR to percentage increase, then to population
                                const aor = parseFloat(aorMatch[1]);
                                const increasePercent = (aor - 1) * 100;
                                // Estimate population based on percentage (rough calculation)
                                return Math.round((increasePercent / 10) * 1000000); // Rough conversion
                            }
                        }
                        return null;
                        
                    case 'healthcare':
                        // Extract healthcare costs like "$8,000-12,000", "$10,836"
                        const healthMatch = value.match(/\$(\d+,?\d*)/);
                        return healthMatch ? parseInt(healthMatch[1].replace(',', '')) : null;
                        
                    case 'productivity':
                        // Extract productivity costs like "$5,000-9,000"
                        const prodMatch = value.match(/\$(\d+,?\d*)/);
                        return prodMatch ? parseInt(prodMatch[1].replace(',', '')) : null;
                        
                    case 'duration':
                        // Extract durations like "3.9 years", "4-9 months"
                        if (value.includes('years')) {
                            const yearsMatch = value.match(/(\d+\.?\d*)\s*years/);
                            return yearsMatch ? parseFloat(yearsMatch[1]) : null;
                        }
                        if (value.includes('months')) {
                            const monthsMatch = value.match(/(\d+)-?(\d+)?\s*months/);
                            if (monthsMatch) {
                                const months = monthsMatch[2] ? 
                                    (parseInt(monthsMatch[1]) + parseInt(monthsMatch[2])) / 2 :
                                    parseInt(monthsMatch[1]);
                                return months / 12; // Convert to years
                            }
                        }
                        return null;
                        
                    case 'yld':
                        // Extract YLD values like "6.2 years"
                        const yldMatch = value.match(/(\d+\.?\d*)\s*years/);
                        return yldMatch ? parseFloat(yldMatch[1]) : null;
                        
                    case 'qol':
                        // Extract QOL percentages like "30-50%"
                        const qolMatch = value.match(/(\d+)-?(\d+)?%/);
                        if (qolMatch) {
                            return qolMatch[2] ? 
                                (parseInt(qolMatch[1]) + parseInt(qolMatch[2])) / 2 :
                                parseInt(qolMatch[1]);
                        }
                        return null;
                        
                    default:
                        return null;
                }
            }
            
            addStudyClickHandlers(param) {
                const studyEntries = document.querySelectorAll('.study-entry[data-clickable="true"]');
                
                studyEntries.forEach(entry => {
                    const applyBtn = entry.querySelector('.apply-study-btn');
                    if (applyBtn) {
                        applyBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.applyStudyValue(param, entry);
                        });
                    }
                    
                    // Also make the whole study clickable
                    entry.addEventListener('click', (e) => {
                        // Don't trigger if clicking on links
                        if (e.target.tagName === 'A') return;
                        this.applyStudyValue(param, entry);
                    });
                });
            }
            
            applyStudyValue(param, studyEntry) {
                const studyIndex = parseInt(studyEntry.dataset.studyIndex);
                const research = RESEARCH_CITATIONS[param];
                const study = research.studies[studyIndex];
                
                const extractedValue = this.extractValueFromStudy(study, param);
                if (extractedValue === null) {
                    console.warn('No applicable value found in study');
                    return;
                }
                
                // Update the parameter
                this.parameters[param] = extractedValue;
                
                // Update the slider
                const container = document.getElementById(`${param}-nouislider`);
                if (container && container.noUiSlider) {
                    container.noUiSlider.set(extractedValue);
                }
                
                // Update displays
                this.updateDisplay(param, extractedValue);
                this.updateDistributionChart(param);
                this.updateAllDisplays();
                
                // Visual feedback
                this.showStudyAppliedFeedback(study.title, param, extractedValue);
                
                // Close modal after short delay
                setTimeout(() => {
                    document.getElementById('research-modal').classList.add('hidden');
                }, 1500);
                
                console.log(`✅ Applied study value: ${study.title} → ${param} = ${extractedValue}`);
            }
            
            showStudyAppliedFeedback(studyTitle, param, value) {
                // Create a temporary toast notification
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
                toast.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">✅</span>
                        <div>
                            <div class="font-semibold">Study Applied!</div>
                            <div class="text-sm opacity-90">${param}: ${this.formatParameter(param, value)}</div>
                            <div class="text-xs opacity-75">${studyTitle.substring(0, 40)}...</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                // Animate in
                setTimeout(() => {
                    toast.style.transform = 'translateX(0)';
                    toast.style.opacity = '1';
                }, 100);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            // Performance optimization methods
            debouncedChartUpdate(param) {
                // Clear existing timeout
                clearTimeout(this.updateTimeouts[param]);
                
                // Set new timeout for smooth updates
                this.updateTimeouts[param] = setTimeout(() => {
                    this.updateDistributionChart(param);
                }, 50); // 50ms debounce for responsiveness
            }
            
            optimizedUpdateAllDisplays() {
                // Cancel any pending animation frame
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                }
                
                // Schedule update on next frame
                this.animationFrameId = requestAnimationFrame(() => {
                    const results = this.calculateTotalEconomicImpact();
                    
                    // Cache results for comparison
                    const resultsChanged = !this.lastResults || 
                        Math.abs(results.total - this.lastResults.total) > 1e6; // $1M threshold
                    
                    if (resultsChanged) {
                        this.updateDisplayElements(results);
                        this.lastResults = results;
                    }
                    
                    this.animationFrameId = null;
                });
            }
            
            updateDisplayElements(results) {
                // Batch DOM updates for better performance
                const updates = [
                    { id: 'total-cost', value: this.formatLargeNumber(results.total) },
                    { id: 'hero-total-cost', value: this.formatLargeNumber(results.total) },
                    { id: 'gdp-percentage', value: `${((results.total / 24e12) * 100).toFixed(1)}%` }
                ];
                
                // Apply updates with smooth transitions
                updates.forEach(update => {
                    const element = document.getElementById(update.id);
                    if (element && element.textContent !== update.value) {
                        this.smoothUpdateElement(element, update.value);
                    }
                });
                
                this.updateFormulaDisplays(results);
                this.updateBreakdownChart(results);
            }
            
            smoothUpdateElement(element, newValue) {
                // Add transition class
                element.style.transition = 'all 0.3s ease';
                element.style.transform = 'scale(1.05)';
                
                setTimeout(() => {
                    element.textContent = newValue;
                    element.style.transform = 'scale(1)';
                }, 150);
            }
            
            getCachedChart(param) {
                const cacheKey = `${param}-${this.parameters[param]}`;
                return this.chartCache.get(cacheKey);
            }
            
            setCachedChart(param, chartData) {
                const cacheKey = `${param}-${this.parameters[param]}`;
                this.chartCache.set(cacheKey, chartData);
                
                // Limit cache size
                if (this.chartCache.size > 50) {
                    const firstKey = this.chartCache.keys().next().value;
                    this.chartCache.delete(firstKey);
                }
            }
            
            updateFormulaDisplays(results) {
                const { suicides, attribution, vsl, depression, yld, qol, healthcare, productivity, duration } = this.parameters;
                
                // Mortality formula
                const mortalityElement = document.getElementById('mortality-result');
                if (mortalityElement) {
                    mortalityElement.textContent = `${Math.round(suicides/1000)}K × ${attribution}% × $${vsl}M = ${this.formatLargeNumber(results.mortality)}`;
                }
                
                // Mental health formula
                const mentalElement = document.getElementById('mental-result');
                if (mentalElement) {
                    mentalElement.textContent = `${(depression/1000000).toFixed(1)}M × ${yld} × ${qol}% × $${Math.round(vsl * 1000000 / 75 / 1000)}K = ${this.formatLargeNumber(results.mental)}`;
                }
                
                // Economic formula
                const economicElement = document.getElementById('healthcare-result');
                if (economicElement) {
                    economicElement.textContent = `${(depression/1000000).toFixed(1)}M × ($${Math.round(healthcare/1000)}K + $${Math.round(productivity/1000)}K) × ${duration} = ${this.formatLargeNumber(results.productivity)}`;
                }
            }
        }
        
        // Initialize calculator when libraries are loaded
        function initializeCalculator() {
            if (typeof noUiSlider !== 'undefined' && typeof d3 !== 'undefined') {
                try {
                    window.calculator = new SocialMediaCalculator();
                    console.log('✅ Calculator initialized successfully');
                    
                    // Initialize all parameter displays
                    Object.keys(window.calculator.parameters).forEach(param => {
                        window.calculator.updateDisplay(param, window.calculator.parameters[param]);
                    });
                    
                    // Add debug utilities
                    window.testSliders = function() {
                        console.log('🧪 Testing sliders...');
                        const params = ['vsl', 'attribution', 'depression'];
                        params.forEach(param => {
                            const container = document.getElementById(`${param}-nouislider`);
                            if (container && container.noUiSlider) {
                                console.log(`✅ ${param} slider: Working`);
                            } else {
                                console.log(`❌ ${param} slider: Not found`);
                            }
                        });
                    };
                    
                    window.testCharts = function() {
                        console.log('🧪 Testing distribution charts...');
                        const params = ['vsl', 'attribution', 'depression'];
                        params.forEach(param => {
                            const chart = document.getElementById(`${param}-distribution`);
                            const hasElements = chart && chart.children.length > 0;
                            console.log(`${hasElements ? '✅' : '❌'} ${param} chart: ${hasElements ? 'Rendered' : 'Empty'}`);
                        });
                    };
                    
                    window.testScenarios = function() {
                        console.log('🧪 Testing scenarios...');
                        window.calculator.loadScenario('optimistic');
                        setTimeout(() => {
                            window.calculator.loadScenario('aggressive');
                            setTimeout(() => {
                                window.calculator.loadScenario('reset');
                                console.log('✅ All scenarios tested');
                            }, 500);
                        }, 500);
                    };
                    
                    window.testDistributionUpdates = function() {
                        console.log('🧪 Testing distribution curve updates...');
                        const params = ['vsl', 'attribution', 'depression'];
                        
                        params.forEach((param, index) => {
                            setTimeout(() => {
                                const config = window.calculator.getParameterConfig(param);
                                const testValue = config.min + (config.max - config.min) * 0.7; // 70% of range
                                
                                console.log(`📊 Testing ${param}: setting to ${testValue} - curve should reshape`);
                                window.calculator.parameters[param] = testValue;
                                window.calculator.updateDistributionChart(param); // Recreate entire curve
                                window.calculator.updateDisplay(param, testValue);
                                
                                // Also update the slider
                                const container = document.getElementById(`${param}-nouislider`);
                                if (container && container.noUiSlider) {
                                    container.noUiSlider.set(testValue);
                                }
                            }, index * 1500);
                        });
                        
                        setTimeout(() => {
                            console.log('✅ Distribution curve test complete - curves should have reshaped and red lines moved to peaks!');
                        }, 5000);
                    };
                    
                    window.testResponsiveCharts = function() {
                        console.log('🧪 Testing responsive chart sizing...');
                        const params = ['vsl', 'attribution', 'depression'];
                        
                        params.forEach(param => {
                            const container = document.getElementById(`${param}-distribution`);
                            if (container) {
                                const containerWidth = container.parentElement.clientWidth;
                                console.log(`📏 ${param}: container width = ${containerWidth}px`);
                                window.calculator.createDistributionChart(param);
                            }
                        });
                        
                        console.log('✅ Responsive chart test complete - check console for widths');
                    };
                    
                    window.testPerformance = function() {
                        console.log('⚡ Testing performance optimizations...');
                        const startTime = performance.now();
                        
                        // Test rapid parameter changes
                        const params = ['vsl', 'attribution', 'depression'];
                        let updates = 0;
                        
                        const interval = setInterval(() => {
                            params.forEach(param => {
                                const config = window.calculator.getParameterConfig(param);
                                const randomValue = config.min + Math.random() * (config.max - config.min);
                                window.calculator.parameters[param] = randomValue;
                                window.calculator.debouncedChartUpdate(param);
                                window.calculator.updateDisplay(param, randomValue);
                            });
                            
                            window.calculator.optimizedUpdateAllDisplays();
                            updates++;
                            
                            if (updates >= 20) {
                                clearInterval(interval);
                                const endTime = performance.now();
                                const duration = endTime - startTime;
                                const fps = (updates * 1000) / duration;
                                
                                console.log(`✅ Performance test complete:`);
                                console.log(`   Duration: ${duration.toFixed(1)}ms`);
                                console.log(`   Updates: ${updates}`);
                                console.log(`   FPS: ${fps.toFixed(1)}`);
                                console.log(`   Cache size: ${window.calculator.chartCache.size}`);
                                
                                // Reset to defaults
                                window.calculator.loadScenario('reset');
                            }
                        }, 100);
                    };
                    
                    window.testMobileFeatures = function() {
                        console.log('📱 Testing mobile features...');
                        
                        // Test touch-friendly elements
                        const infoButtons = document.querySelectorAll('.info-btn');
                        const scenarioButtons = document.querySelectorAll('.scenario-btn');
                        
                        console.log(`   Info buttons: ${infoButtons.length} (touch-friendly: ${infoButtons.length > 0 ? '✅' : '❌'})`);
                        console.log(`   Scenario buttons: ${scenarioButtons.length} (touch-friendly: ${scenarioButtons.length > 0 ? '✅' : '❌'})`);
                        
                        // Test modal responsiveness
                        const modal = document.getElementById('research-modal');
                        if (modal) {
                            console.log(`   Research modal: ✅ Available`);
                            console.log(`   Mobile viewport: ${window.innerWidth}px x ${window.innerHeight}px`);
                            console.log(`   Touch device: ${('ontouchstart' in window) ? '✅' : '❌'}`);
                        }
                        
                        console.log('✅ Mobile features test complete');
                    };
                    
                    window.testInfoButtons = function() {
                        console.log('ℹ️ Testing all info buttons and research data...');
                        
                        const expectedParams = ['vsl', 'suicides', 'attribution', 'depression', 'yld', 'qol', 'healthcare', 'productivity', 'duration'];
                        const infoButtons = document.querySelectorAll('.info-btn');
                        const foundParams = Array.from(infoButtons).map(btn => btn.dataset.param);
                        
                        console.log(`   Expected parameters: ${expectedParams.length}`);
                        console.log(`   Found info buttons: ${infoButtons.length}`);
                        
                        expectedParams.forEach(param => {
                            const hasButton = foundParams.includes(param);
                            const hasData = RESEARCH_CITATIONS[param] !== undefined;
                            const hasStudies = hasData && RESEARCH_CITATIONS[param].studies && RESEARCH_CITATIONS[param].studies.length > 0;
                            
                            console.log(`   ${param}: Button ${hasButton ? '✅' : '❌'} | Data ${hasData ? '✅' : '❌'} | Studies ${hasStudies ? '✅' : '❌'}`);
                            
                            if (hasData && hasStudies) {
                                console.log(`     → ${RESEARCH_CITATIONS[param].studies.length} studies available`);
                            }
                        });
                        
                        // Test clicking each button
                        console.log('   Testing button clicks...');
                        infoButtons.forEach((button, index) => {
                            const param = button.dataset.param;
                            try {
                                window.calculator.showResearchModal(param);
                                const modal = document.getElementById('research-modal');
                                const isVisible = !modal.classList.contains('hidden');
                                console.log(`     ${param} button click: ${isVisible ? '✅' : '❌'}`);
                                
                                // Close modal
                                modal.classList.add('hidden');
                            } catch (error) {
                                console.log(`     ${param} button click: ❌ Error: ${error.message}`);
                            }
                        });
                        
                        console.log('✅ Info buttons test complete');
                    };
                    
                    window.testStudyApplication = function() {
                        console.log('🧪 Testing study value extraction and application...');
                        
                        const testParams = ['vsl', 'attribution', 'healthcare', 'productivity', 'duration'];
                        
                        testParams.forEach(param => {
                            console.log(`\n📊 Testing ${param} parameter:`);
                            const research = RESEARCH_CITATIONS[param];
                            
                            if (!research || !research.studies) {
                                console.log(`   ❌ No research data for ${param}`);
                                return;
                            }
                            
                            research.studies.forEach((study, index) => {
                                const extractedValue = window.calculator.extractValueFromStudy(study, param);
                                const hasValue = extractedValue !== null;
                                
                                console.log(`   Study ${index + 1}: "${study.title.substring(0, 30)}..."`);
                                console.log(`     Value string: "${study.value}"`);
                                console.log(`     Extracted: ${hasValue ? window.calculator.formatParameter(param, extractedValue) : 'None'} ${hasValue ? '✅' : '❌'}`);
                                
                                if (hasValue) {
                                    // Test applying the value (but restore original after)
                                    const originalValue = window.calculator.parameters[param];
                                    console.log(`     Testing application: ${window.calculator.formatParameter(param, originalValue)} → ${window.calculator.formatParameter(param, extractedValue)}`);
                                    
                                    // Apply and then restore
                                    window.calculator.parameters[param] = extractedValue;
                                    window.calculator.updateDisplay(param, extractedValue);
                                    
                                    setTimeout(() => {
                                        window.calculator.parameters[param] = originalValue;
                                        window.calculator.updateDisplay(param, originalValue);
                                        const container = document.getElementById(`${param}-nouislider`);
                                        if (container && container.noUiSlider) {
                                            container.noUiSlider.set(originalValue);
                                        }
                                    }, 100);
                                }
                            });
                        });
                        
                        console.log('\n✅ Study application test complete');
                        console.log('💡 Try clicking info buttons and then clicking on studies with "📊 Apply Value" buttons!');
                    };
                    
                    window.testEvidenceRanges = function() {
                        console.log('📊 Testing evidence-based ranges alignment...');
                        
                        // Expected evidence ranges from research
                        const evidenceRanges = {
                            vsl: { min: 7.0, max: 14.0 },
                            suicides: { min: 60000, max: 120000 },
                            attribution: { min: 7, max: 22 },
                            depression: { min: 2000000, max: 8000000 },
                            yld: { min: 4.8, max: 7.5 },
                            qol: { min: 31, max: 47 },
                            healthcare: { min: 6500, max: 12000 },
                            productivity: { min: 4800, max: 8500 },
                            duration: { min: 3.0, max: 6.8 }
                        };
                        
                        // Test slider ranges
                        console.log('\n🎛️ Slider Range Validation:');
                        Object.keys(evidenceRanges).forEach(param => {
                            const container = document.getElementById(`${param}-nouislider`);
                            if (container && container.noUiSlider) {
                                const options = container.noUiSlider.options;
                                const sliderMin = options.range.min;
                                const sliderMax = options.range.max;
                                const expectedMin = evidenceRanges[param].min;
                                const expectedMax = evidenceRanges[param].max;
                                
                                const minMatch = Math.abs(sliderMin - expectedMin) < 0.01;
                                const maxMatch = Math.abs(sliderMax - expectedMax) < 0.01;
                                
                                console.log(`   ${param}: ${minMatch && maxMatch ? '✅' : '❌'} Slider[${sliderMin}-${sliderMax}] vs Evidence[${expectedMin}-${expectedMax}]`);
                            } else {
                                console.log(`   ${param}: ❌ Slider not found`);
                            }
                        });
                        
                        // Test scenario ranges
                        console.log('\n🎯 Scenario Range Validation:');
                        Object.keys(window.calculator.scenarios).forEach(scenarioName => {
                            const scenario = window.calculator.scenarios[scenarioName];
                            console.log(`   ${scenarioName} scenario:`);
                            let allValid = true;
                            
                            Object.keys(evidenceRanges).forEach(param => {
                                const value = scenario[param];
                                const min = evidenceRanges[param].min;
                                const max = evidenceRanges[param].max;
                                const isValid = value >= min && value <= max;
                                
                                if (!isValid) {
                                    allValid = false;
                                    console.log(`     ${param}: ❌ ${value} outside range [${min}, ${max}]`);
                                }
                            });
                            
                            if (allValid) {
                                console.log(`     ✅ All parameters within evidence ranges`);
                            }
                        });
                        
                        console.log('\n✅ Evidence range validation complete');
                    };
                    
                    console.log('🔧 Debug utilities available:');
                    console.log('  testSliders() - Test slider functionality');
                    console.log('  testCharts() - Test distribution charts');
                    console.log('  testScenarios() - Test scenario loading');
                    console.log('  testDistributionUpdates() - Test red line movement');
                    console.log('  testResponsiveCharts() - Test responsive sizing');
                    console.log('  testPerformance() - Test performance optimizations');
                    console.log('  testMobileFeatures() - Test mobile enhancements');
                    console.log('  testInfoButtons() - Test research info buttons');
                    console.log('  testStudyApplication() - Test interactive study features');
                    console.log('  testEvidenceRanges() - Validate evidence-based parameter ranges');
                    
                    // Hide loading screen
                    document.getElementById('loading-screen').classList.add('hidden');
                } catch (error) {
                    console.error('❌ Calculator initialization failed:', error);
                    document.getElementById('error-banner').classList.add('show');
                }
            } else {
                console.log('⏳ Waiting for libraries...');
                setTimeout(initializeCalculator, 100);
            }
        }
        
        // Start initialization
        window.addEventListener('load', () => {
            setTimeout(initializeCalculator, 100);
        });
    </script>

    <!-- Enhanced Analytics for Modular System -->
    <script>
      // Track modular system performance
      if (typeof gtag !== 'undefined') {
        gtag('config', 'G-RQ28MDK57K', {
          custom_map: {
            'system_type': 'modular',
            'version': '2.1'
          }
        });
        
        // Track system initialization
        window.addEventListener('load', () => {
          gtag('event', 'modular_system_loaded', {
            'event_category': 'performance',
            'file_size_reduction': '95%',
            'architecture': 'modular_enhanced'
          });
        });
      }
    </script>
    
    <!-- Google tag (gtag.js) -->
</body>
</html> 